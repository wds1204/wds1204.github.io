<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <title>
    Java Binder解析 |
    
    modi.wu
  </title>
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <main class="content">
    <section class="outer">
  <article id="java-Java Binder解析" class="article article-type-java" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h1 class="article-title" itemprop="name">
  Java Binder解析
</h1>



    </header>
    

    
    <div class="article-meta">
      <a href="/2022/01/18/Java%20Binder%E8%A7%A3%E6%9E%90/" class="article-date">
  <time datetime="2022-01-18T13:52:20.000Z" itemprop="datePublished">2022-01-18</time>
</a>
      
<div class="article-category">
  <a class="article-category-link" href="/categories/android/">android</a> / <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">源码解析</a>
</div>

    </div>
    

    
    
<div class="tocbot"></div>

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
      <p>在Native Binder的系统服务注册过程中，核心是<code>ServiceManager</code>,在Java Binder中，也有一个<code>ServiceManager</code>，然而这个<code>ServiceManager</code>是个Java文件。在Java Binder注册系统服务到也需要用到<code>ServiceManager</code>，那么需要选择一个系统服务来窥探这一过程，这里以常见的<code>ActivityManagerServcie</code>（AMS）为例。</p>
<span id="more"></span>

<h3 id="1-将AMS注册到ServiceManager"><a href="#1-将AMS注册到ServiceManager" class="headerlink" title="1-将AMS注册到ServiceManager"></a>1-将AMS注册到ServiceManager</h3><p>在AMS的<code>setSystemProcess</code>方法中，会调用<code>ServiceManager</code>的<code>addService</code>方法，至于为什么会调用AMS的<code>setSystemProcess</code>方法可自行查阅<code>SystemService</code>进程的启动流程。</p>
<blockquote>
<p>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSystemProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           ServiceManager.addService(Context.ACTIVITY_SERVICE, <span class="keyword">this</span>, <span class="comment">/* allowIsolated= */</span> <span class="keyword">true</span>,</span><br><span class="line">                   DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PRIORITY_NORMAL | DUMP_FLAG_PROTO);</span><br><span class="line">           ServiceManager.addService(ProcessStats.SERVICE_NAME, mProcessStats);</span><br><span class="line">           <span class="comment">//...         ;/..../xs[--------------------------gh]</span></span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                   <span class="string">&quot;Unable to find android system package&quot;</span>, e);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//...</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>Context.ACTIVITY_SERVICE</code>的值为<code>activity</code>,和Native Binder类事把服务名添加到<code>ServiceManager</code>中。</p>
<blockquote>
<p>frameworks/base/core/java/android/os/ServiceManager.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addService</span><span class="params">(String name, IBinder service, <span class="keyword">boolean</span> allowIsolated,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> dumpPriority)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getIServiceManager().addService(name, service, allowIsolated, dumpPriority);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;error in addService&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>主要看<code>getIServiceManager</code>方法返回的是什么，代码如下</p>
<blockquote>
<p>frameworks/base/core/java/android/os/ServiceManager.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IServiceManager <span class="title">getIServiceManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sServiceManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> sServiceManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the service manager</span></span><br><span class="line">    sServiceManager = ServiceManagerNative</span><br><span class="line">            .asInterface(Binder.allowBlocking(BinderInternal.getContextObject()));</span><br><span class="line">    <span class="keyword">return</span> sServiceManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>BinderInternal.getContextObject())</li>
<li>ServiceManagerNative.asInterface</li>
<li>getIServiceManager().addService</li>
</ul>
<h4 id="1-1-BinderInternal-getContextObject"><a href="#1-1-BinderInternal-getContextObject" class="headerlink" title="1.1-BinderInternal.getContextObject"></a>1.1-BinderInternal.getContextObject</h4><p>Binder.allowBlocking的作用就是将BinderProxy的<code>mWarnOnBlocking</code>的值设置为 false，主要分析的<code>BinderInternal.getContextObject</code>方法的作用，这是一个Native方法。在<a href="https://wds1204.github.io/2022/01/17/Java%20Binder%E7%9A%84JNI%E6%B3%A8%E5%86%8C/">Java Binder的JNI注册</a>文章中说了会注册<code>BinderInternal</code>的Native方法。<code>getContextObject</code>就是其中之一，它对于JNI函数如下：</p>
<blockquote>
<p>frameworks/base/core/jni/android_util_Binder.cpp</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jobject <span class="title">android_os_BinderInternal_getContextObject</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;IBinder&gt; b = ProcessState::<span class="built_in">self</span>()-&gt;<span class="built_in">getContextObject</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">javaObjectForIBinder</span>(env, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又看见了熟悉的<code>ProcessState::self()-&gt;getContextObject(NULL)</code>,最终会返回个<code>BpBinder</code>,不熟悉的朋友可以查看<a href="https://wds1204.github.io/2021/12/30/Native%20Binder%E6%9C%BA%E5%88%B6%E4%B9%8B%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C/#2-ProcessState%E5%AE%9E%E4%BE%8B">Native Binder机制之系统服务注册</a>。<code>BpBinder</code>是Native Binder的客户端，这说明Java Binder需要Native的<code>BpBinder</code>，但是<code>BpBinder</code>在Java层无法直接使用，所以这里使用<code>javaObjectForIBinder</code>函数进行处理，代码如下：</p>
<blockquote>
<p>frameworks/base/core/jni/android_util_Binder.cpp</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If the argument is a JavaBBinder, return the Java object that was used to create it.</span></span><br><span class="line"><span class="comment">// Otherwise return a BinderProxy for the IBinder. If a previous call was passed the</span></span><br><span class="line"><span class="comment">// same IBinder, and the original BinderProxy is still alive, return the same BinderProxy.</span></span><br><span class="line"><span class="function">jobject <span class="title">javaObjectForIBinder</span><span class="params">(JNIEnv* env, <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (val == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (val-&gt;<span class="built_in">checkSubclass</span>(&amp;gBinderOffsets)) &#123;</span><br><span class="line">        <span class="comment">// It&#x27;s a JavaBBinder created by ibinderForJavaObject. Already has Java object.</span></span><br><span class="line">        jobject object = <span class="keyword">static_cast</span>&lt;JavaBBinder*&gt;(val.<span class="built_in">get</span>())-&gt;<span class="built_in">object</span>();</span><br><span class="line">        <span class="built_in">LOGDEATH</span>(<span class="string">&quot;objectForBinder %p: it&#x27;s our own %p!\n&quot;</span>, val.<span class="built_in">get</span>(), object);</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For the rest of the function we will hold this lock, to serialize</span></span><br><span class="line">    <span class="comment">// looking/creation/destruction of Java proxies for native Binder proxies.</span></span><br><span class="line">    AutoMutex _l(gProxyLock);</span><br><span class="line"></span><br><span class="line">    BinderProxyNativeData* nativeData = gNativeDataCache;</span><br><span class="line">    <span class="keyword">if</span> (nativeData == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        nativeData = <span class="keyword">new</span> <span class="built_in">BinderProxyNativeData</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// gNativeDataCache is now logically empty.</span></span><br><span class="line">    jobject object = env-&gt;<span class="built_in">CallStaticObjectMethod</span>(gBinderProxyOffsets.mClass,</span><br><span class="line">            gBinderProxyOffsets.mGetInstance, (jlong) nativeData, (jlong) val.<span class="built_in">get</span>());</span><br><span class="line">    <span class="keyword">if</span> (env-&gt;<span class="built_in">ExceptionCheck</span>()) &#123;</span><br><span class="line">        <span class="comment">// In the exception case, getInstance still took ownership of nativeData.</span></span><br><span class="line">        gNativeDataCache = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    BinderProxyNativeData* actualNativeData = <span class="built_in">getBPNativeData</span>(env, object);</span><br><span class="line">    <span class="keyword">if</span> (actualNativeData == nativeData) &#123;</span><br><span class="line">        <span class="comment">// New BinderProxy; we still have exclusive access.</span></span><br><span class="line">        nativeData-&gt;mOrgue = <span class="keyword">new</span> DeathRecipientList;</span><br><span class="line">        nativeData-&gt;mObject = val;<span class="comment">//保存BpBinder</span></span><br><span class="line">        gNativeDataCache = <span class="literal">nullptr</span>;</span><br><span class="line">        ++gNumProxies;</span><br><span class="line">        <span class="keyword">if</span> (gNumProxies &gt;= gProxiesWarned + PROXY_WARN_INTERVAL) &#123;</span><br><span class="line">            <span class="built_in">ALOGW</span>(<span class="string">&quot;Unexpectedly many live BinderProxies: %d\n&quot;</span>, gNumProxies);</span><br><span class="line">            gProxiesWarned = gNumProxies;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// nativeData wasn&#x27;t used. Reuse it the next time.</span></span><br><span class="line">        gNativeDataCache = nativeData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先看这个函数的注释:</p>
<blockquote>
<p>If the argument is a JavaBBinder, return the Java object that was used to create it.<br> Otherwise return a BinderProxy for the IBinder. If a previous call was passed the<br> same IBinder, and the original BinderProxy is still alive, return the same BinderProxy.</p>
</blockquote>
<p>解释的很清楚，如果参数是<code>JavaBBinder</code>，则返回用于创建它的Java对象。否则为返回一个<code>BinderProxy</code>。如果之前的调用传递<code>IBinder</code>相同，并且<code>BinderProxy</code>已存在，则这把<code>BinderProxy</code>返回。此时调用<code>javaObjectForIBinder</code>的参数是<code>BpBinder</code>,显然会返回一个<code>BinderProxy</code>。</p>
<p>还是记得之前<a href="https://wds1204.github.io/2022/01/17/Java%20Binder%E7%9A%84JNI%E6%B3%A8%E5%86%8C/#3-BinderProxy%E7%B1%BB%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96">BinderProxy类的初始化</a>吗,会在<code>gBinderProxyOffsets</code>这个结构体保存<code>BinderProxy</code>类一些相关信息。<br>一步步分析<code>javaObjectForIBinder</code>函数，<br>先看如下部分</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BinderProxyNativeData* nativeData = gNativeDataCache;</span><br><span class="line"><span class="keyword">if</span> (nativeData == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    nativeData = <span class="keyword">new</span> <span class="built_in">BinderProxyNativeData</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建一个<code>BinderProxyNativeData</code>对象复制给<code>nativeData</code>，先其内部的空的。</p>
<p>注意下面这行代码:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gNativeDataCache is now logically empty.</span></span><br><span class="line">jobject object = env-&gt;<span class="built_in">CallStaticObjectMethod</span>(gBinderProxyOffsets.mClass,</span><br><span class="line">            gBinderProxyOffsets.mGetInstance, (jlong) nativeData, (jlong) val.<span class="built_in">get</span>());</span><br></pre></td></tr></table></figure>
<p>其实是调用Java层<code>BinderProxy.getInstance</code>方法,入参数分别是<code>BinderProxyNativeData</code>对象和<code>BpBinder</code></p>
<blockquote>
<p>frameworks/base/core/java/android/os/Binder.java::BinderProxy</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BinderProxy <span class="title">getInstance</span><span class="params">(<span class="keyword">long</span> nativeData, <span class="keyword">long</span> iBinder)</span> </span>&#123;</span><br><span class="line">    BinderProxy result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//根据BpBinder先从Map中取，BinderProxy</span></span><br><span class="line">        result = sProxyMap.<span class="built_in">get</span>(iBinder);</span><br><span class="line">        <span class="keyword">if</span> (result != null) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        result = <span class="keyword">new</span> <span class="built_in">BinderProxy</span>(nativeData);</span><br><span class="line">    &#125; <span class="built_in"><span class="keyword">catch</span></span> (Throwable e) &#123;</span><br><span class="line">        <span class="comment">// We&#x27;re throwing an exception (probably OOME); don&#x27;t drop nativeData.</span></span><br><span class="line">        NativeAllocationRegistry.<span class="built_in">applyFreeFunction</span>(NoImagePreloadHolder.sNativeFinalizer,</span><br><span class="line">                nativeData);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    NoImagePreloadHolder.sRegistry.<span class="built_in">registerNativeAllocation</span>(result, nativeData);</span><br><span class="line">    <span class="comment">// The registry now owns nativeData, even if registration threw an exception.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//缓存BinderProxy</span></span><br><span class="line">    sProxyMap.<span class="built_in">set</span>(iBinder, result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">BinderProxy</span><span class="params">(<span class="keyword">long</span> nativeData)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//把native层的BinderProxyNativeData赋值给mNativeData字段</span></span><br><span class="line">    mNativeData = nativeData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>关于<code>getBPNativeData</code>部分的代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//objexct为BinderProxy</span></span><br><span class="line">BinderProxyNativeData* actualNativeData = <span class="built_in">getBPNativeData</span>(env, object);</span><br><span class="line"></span><br><span class="line"><span class="function">BinderProxyNativeData* <span class="title">getBPNativeData</span><span class="params">(JNIEnv* env, jobject obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (BinderProxyNativeData *) env-&gt;<span class="built_in">GetLongField</span>(obj, gBinderProxyOffsets.mNativeData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>getBPNativeData</code>函数其实就是获取Java层<code>BinderProxy</code>的 <code>mNativeData</code>属性字段。</p>
<p>最后一段代码，逻辑上就是给<code>gNativeDataCache</code>的mObject和mOrgue赋值，注意<code>mObject</code>就是<code>BpBinder</code>，然后复用<code>gNativeDataCache</code>,</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (actualNativeData == nativeData) &#123;</span><br><span class="line">        <span class="comment">// New BinderProxy; we still have exclusive access.</span></span><br><span class="line">        nativeData-&gt;mOrgue = <span class="keyword">new</span> DeathRecipientList;</span><br><span class="line">        nativeData-&gt;mObject = val;<span class="comment">//保存BpBinder</span></span><br><span class="line">        gNativeDataCache = <span class="literal">nullptr</span>;</span><br><span class="line">        ++gNumProxies;</span><br><span class="line">        <span class="keyword">if</span> (gNumProxies &gt;= gProxiesWarned + PROXY_WARN_INTERVAL) &#123;</span><br><span class="line">            <span class="built_in">ALOGW</span>(<span class="string">&quot;Unexpectedly many live BinderProxies: %d\n&quot;</span>, gNumProxies);</span><br><span class="line">            gProxiesWarned = gNumProxies;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// nativeData wasn&#x27;t used. Reuse it the next time.</span></span><br><span class="line">        gNativeDataCache = nativeData;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>看了这么一大段代码，一会调用<code>C++</code>,一会有调用<code>Java</code>，Native对象和Java对象互相指向，是不是有点晕。总结一下<code>javaObjectForIBinder</code>函数：</p>
<ol>
<li>如果<code>nativeData</code>为空的话，就创建一个<code>BinderProxyNativeData</code>对象</li>
<li>调用Java层<code>BinderProxy</code>的<code>getInstance</code>方法返回一个Java层的<code>BinderProxy</code>对象<ol>
<li><code>getInstance</code>方法两个入参数Native层的<code>nativeData</code>和<code>BpBinder</code></li>
<li>在<code>getInstance</code>方法内会把<code>nativeData</code>赋值给Java 层<code>BinderProxy</code>的<code>mNativeData</code>字段。</li>
<li>根据Native层<code>BpBinder</code>缓存<code>BinderProxy</code>对象</li>
</ol>
</li>
<li>通过<code>getBPNativeData</code>函数获取Java层<code>BinderProxy</code>的成员变量<code>mNativeData</code>指向Native的<code>BinderProxyNativeData</code></li>
<li>最终<code>javaObjectForIBinder</code>函数会返回Java层的BpBinder</li>
</ol>
<p>关于为什么这么设计，没看到查到更多设计文档，但从<code>BinderProxyNativeData</code>上的注释的可知一二：减少 JNI Java 字段访问的数量</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// We aggregate native pointer fields for BinderProxy in a single object to allow</span></span><br><span class="line"><span class="comment">// management with a single NativeAllocationRegistry, and to reduce the number of JNI</span></span><br><span class="line"><span class="comment">// Java field accesses. This costs us some extra indirections here.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BinderProxyNativeData</span> &#123;</span></span><br><span class="line">    <span class="comment">// The native IBinder proxied by this BinderProxy.</span></span><br><span class="line">    sp&lt;IBinder&gt; mObject;</span><br><span class="line">    sp&lt;DeathRecipientList&gt; mOrgue; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="1-2-ServiceManagerNative-asInterface"><a href="#1-2-ServiceManagerNative-asInterface" class="headerlink" title="1.2-ServiceManagerNative.asInterface"></a>1.2-ServiceManagerNative.asInterface</h4><p>还记得Native层的障眼法<code>asInterface</code>函数，它的作用就是通过<code>BpBinder</code>创建一个<code>BpServiceManager</code>。那在Java层的<code>asInterface</code>方法到底是干什么呢？</p>
<blockquote>
<p>android.os.ServiceManagerNative</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IServiceManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    IServiceManager in =</span><br><span class="line">        (IServiceManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">    <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ServiceManagerProxy(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的obj的值为<code>BinderProxy</code>,那<code>asInterface</code>方法的作用就是以<code>BinderProxy</code>创建一个<code>ServiceManagerProxy</code>对象。</p>
<p><code>BinderProxy</code>和<code>BpBinder</code>分别代表Java层和Native层的客户端。在Native层<code>BpServiceManager</code>通过<code>BpBinder</code>来通信。<br>在Java层<code>ServiceManagerProxy</code>将业务请求交给<code>BinderProxy</code>处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sServiceManager = ServiceManagerNative.asInterface(Binder.allowBlocking(BinderInternal.getContextObject()));</span><br></pre></td></tr></table></figure>

<p>上面的代码经过前面篇幅的分析，其实可以转化为如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sServiceManager =<span class="keyword">new</span> ServiceManagerProxy(<span class="keyword">new</span> BinderProxy()));</span><br></pre></td></tr></table></figure>


<h4 id="1-3-getIServiceManager-addService"><a href="#1-3-getIServiceManager-addService" class="headerlink" title="1.3-getIServiceManager().addService"></a>1.3-getIServiceManager().addService</h4><p><code>getIServiceManager()</code>返回的是<code>ServiceManagerProxy</code>,<code>ServiceManagerProxy</code>是<code>ServiceManagerNative</code>的内部类。它实现了<code>IServiceManager</code>的接口。</p>
<blockquote>
<p>android.os.ServiceManagerNative.java::ServiceManagerProxy</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addService</span><span class="params">(String name, IBinder service, boolean allowIsolated, <span class="keyword">int</span> dumpPriority)</span></span></span><br><span class="line"><span class="function">        throws RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.<span class="built_in">obtain</span>();</span><br><span class="line">    Parcel reply = Parcel.<span class="built_in">obtain</span>();</span><br><span class="line">    data.<span class="built_in">writeInterfaceToken</span>(IServiceManager.descriptor);</span><br><span class="line">    data.<span class="built_in">writeString</span>(name);</span><br><span class="line">    data.<span class="built_in">writeStrongBinder</span>(service);<span class="comment">//service就是ActivityManagerService</span></span><br><span class="line">    data.<span class="built_in">writeInt</span>(allowIsolated ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    data.<span class="built_in">writeInt</span>(dumpPriority);</span><br><span class="line">    mRemote.<span class="built_in">transact</span>(ADD_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.<span class="built_in">recycle</span>();</span><br><span class="line">    data.<span class="built_in">recycle</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里和Native层的addService很像，分别创建请求和接受的数据包Parcel。把service写入到data中，关于<code>data.writeStrongBinder(service)</code>后面会重点将。调用<code>mRemote</code>的<code>transact</code>方法，<code>ADD_SERVICE_TRANSACTION</code>在Native层也见到过，最终会在内核层处理这个switch/case。但问题是现在Java层，如何和关联Native层服务注册呢？<br>关键就在于<code>mRemote</code>就是<code>BinderProxy</code>,看它的<code>transact</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">transact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> transactNative(code, data, reply, flags);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tracingEnabled) &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ALWAYS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">transactNative</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br></pre></td></tr></table></figure>
<p>最终会调用一个 native函数，再次回到<code>android_util_Binder.cpp</code></p>
<blockquote>
<p>frameworks/base/core/jni/android_util_Binder.cpp</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod gBinderProxyMethods[] = &#123;</span><br><span class="line">     <span class="comment">/* name, signature, funcPtr */</span></span><br><span class="line">     <span class="comment">//...</span></span><br><span class="line">    &#123;<span class="string">&quot;transactNative&quot;</span>,      <span class="string">&quot;(ILandroid/os/Parcel;Landroid/os/Parcel;I)Z&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderProxy_transact&#125;,</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jboolean <span class="title">android_os_BinderProxy_transact</span><span class="params">(JNIEnv* env, jobject obj,</span></span></span><br><span class="line"><span class="params"><span class="function">        jint code, jobject dataObj, jobject replyObj, jint flags)</span> <span class="comment">// throws RemoteException</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (dataObj == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">jniThrowNullPointerException</span>(env, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Parcel* data = <span class="built_in">parcelForJavaObject</span>(env, dataObj);<span class="comment">//1、把Java层的发送Parcel转为Native层的Parcel</span></span><br><span class="line">    <span class="keyword">if</span> (data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    Parcel* reply = <span class="built_in">parcelForJavaObject</span>(env, replyObj);<span class="comment">//2、把Java层的接收的Parcel转为Native层的Parcel</span></span><br><span class="line">    <span class="keyword">if</span> (reply == <span class="literal">NULL</span> &amp;&amp; replyObj != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IBinder* target = <span class="built_in">getBPNativeData</span>(env, obj)-&gt;mObject.<span class="built_in">get</span>();<span class="comment">//3</span></span><br><span class="line">    <span class="keyword">if</span> (target == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">jniThrowException</span>(env, <span class="string">&quot;java/lang/IllegalStateException&quot;</span>, <span class="string">&quot;Binder has been finalized!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//printf(&quot;Transact from Java code to %p sending: &quot;, target); data-&gt;print();</span></span><br><span class="line">    <span class="keyword">status_t</span> err = target-&gt;<span class="built_in">transact</span>(code, *data, reply, flags);<span class="comment">//4</span></span><br><span class="line">    <span class="comment">//if (reply) printf(&quot;Transact from Java code to %p received: &quot;, target); reply-&gt;print();</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (kEnableBinderSample) &#123;</span><br><span class="line">        <span class="keyword">if</span> (time_binder_calls) &#123;</span><br><span class="line">            <span class="built_in">conditionally_log_binder_call</span>(start_millis, target, code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_TRUE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err == UNKNOWN_TRANSACTION) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">signalExceptionForError</span>(env, obj, err, <span class="literal">true</span> <span class="comment">/*canThrowRemoteException*/</span>, data-&gt;<span class="built_in">dataSize</span>());</span><br><span class="line">    <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数会先正注释1和注释2处把Java层的请求和接收数据的包转为Native的层的Parcel。然后调用<code>getBPNativeData</code>函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BinderProxyNativeData* <span class="title">getBPNativeData</span><span class="params">(JNIEnv* env, jobject obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (BinderProxyNativeData *) env-&gt;<span class="built_in">GetLongField</span>(obj, gBinderProxyOffsets.mNativeData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取Java层<code>BinderProxy</code>的<code>mNativeData</code>成员变量，<code>mNativeData</code>其实就是Native层的<code>BinderProxyNativeData</code>,返回到注释3，获取<code>BinderProxyNativeData</code>的<code>mObject</code>,也就是<code>BpBinder</code>。接着来到注释4调用<code>BpBinder</code>的<code>transact</code>函数，向Binder驱动发送数据，这部分内容在<a href="https://wds1204.github.io/2021/12/30/Native%20Binder%E6%9C%BA%E5%88%B6%E4%B9%8B%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C/#4-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C">Native Binder机制之系统服务注册</a>已经分析过了，不再赘述。</p>
<h3 id="2-引出JavaBBinder"><a href="#2-引出JavaBBinder" class="headerlink" title="2-引出JavaBBinder"></a>2-引出JavaBBinder</h3><p>在对addService分析时曾提示<code>data.writeStrongBinder(service)</code>，很重要，那它到底最重要在哪呢？</p>
<blockquote>
<p>frameworks/base/core/java/android/os/Parcel.java</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">writeStrongBinder</span><span class="params">(IBinder val)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">nativeWriteStrongBinder</span>(mNativePtr, val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>frameworks/base/core/jni/android_os_Parcel.cpp</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;nativeWriteStrongBinder&quot;</span>,   <span class="string">&quot;(JLandroid/os/IBinder;)V&quot;</span>, (<span class="keyword">void</span>*)android_os_Parcel_writeStrongBinder&#125;,</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_os_Parcel_writeStrongBinder</span><span class="params">(JNIEnv* env, jclass clazz, jlong nativePtr, jobject object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Parcel* parcel = <span class="keyword">reinterpret_cast</span>&lt;Parcel*&gt;(nativePtr);</span><br><span class="line">    <span class="keyword">if</span> (parcel != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">status_t</span> err = parcel-&gt;<span class="built_in">writeStrongBinder</span>(<span class="built_in">ibinderForJavaObject</span>(env, object));</span><br><span class="line">        <span class="keyword">if</span> (err != NO_ERROR) &#123;</span><br><span class="line">            <span class="built_in">signalExceptionForError</span>(env, clazz, err);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>刚刚分析了<code>javaObjectForIBinder</code>,这里又出现了<code>ibinderForJavaObject</code>，从命名上有点倒过来的感觉，有点意思。把Java层传进来Binder通过<code>ibinderForJavaObject</code>函数转换一下保存到<code>parcel</code>数据包中。</p>
<blockquote>
<p>frameworks/base/core/jni/android_util_Binder.cpp</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sp&lt;IBinder&gt; <span class="title">ibinderForJavaObject</span><span class="params">(JNIEnv* env, jobject obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instance of Binder?</span></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;<span class="built_in">IsInstanceOf</span>(obj, gBinderOffsets.mClass)) &#123;<span class="comment">//1</span></span><br><span class="line">        JavaBBinderHolder* jbh = (JavaBBinderHolder*)</span><br><span class="line">            env-&gt;<span class="built_in">GetLongField</span>(obj, gBinderOffsets.mObject);</span><br><span class="line">        <span class="keyword">return</span> jbh-&gt;<span class="built_in">get</span>(env, obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instance of BinderProxy?</span></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;<span class="built_in">IsInstanceOf</span>(obj, gBinderProxyOffsets.mClass)) &#123;<span class="comment">//3</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getBPNativeData</span>(env, obj)-&gt;mObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ALOGW</span>(<span class="string">&quot;ibinderForJavaObject: %p is not a Binder object&quot;</span>, obj);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一种情况：如果Java层obj对象是的<code>Binder</code>类，则获取Java层obj对象的成员mObject,也是就是Native层的<code>JavaBBinderHolder</code>对象，然后调用<code>JavaBBinderHolder</code>的get函数。</p>
<p>第二种情况：如果Java层obj对象是<code>BinderProxy</code>类，则返回<code>BpBinder</code>。</p>
<p>此时的obj是Jave层传入的ActivityManagerService,那得看AMS具体是从什么派生出来的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerService</span> <span class="title">extends</span> <span class="title">IActivityManager</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class"><span class="title">implements</span> <span class="title">Watchdog</span>.<span class="title">Monitor</span>, <span class="title">BatteryStatsImpl</span>.<span class="title">BatteryCallback</span> &#123;</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>ActivityManagerService</code>是继承<code>IActivityManager.Stub</code>，但在代码中是无法直接搜索得该类。只有一个<code>IActivityManager.aidl</code>文件,看到这里应当知道是位编译阶段根据<code>IActivityManager.aidl</code>生成 <code>IActivityManager.java</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IActivityManager</span> <span class="keyword">extends</span> <span class="title">IInterface</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">IActivityManager</span></span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">IActivityManager</span></span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>IActivityManager</code>内部类<code>Stub</code>继承Binder，并实现了<code>IActivityManager</code>接口。所以<code>ActivityManagerService</code>是从<code>Binder</code>派生出来的，并实现了<code>IActivityManager</code>接口。在此时<code>ibinderForJavaObject</code>函数逻辑调用的是第一种情况。先从Jave层Binder获取<code>JavaBBinderHolder</code>，在调用<code>JavaBBinderHolder</code>的get函数。</p>
<blockquote>
<p>Binder的mObject是在构造函数中初始化的</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JavaBBinderHolder</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">sp&lt;JavaBBinder&gt; <span class="title">get</span><span class="params">(JNIEnv* env, jobject obj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        AutoMutex _l(mLock);</span><br><span class="line">        sp&lt;JavaBBinder&gt; b = mBinder.<span class="built_in">promote</span>();</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">//obj是Java层Binder对象也就是AMS</span></span><br><span class="line">            b = <span class="keyword">new</span> <span class="built_in">JavaBBinder</span>(env, obj);</span><br><span class="line">            mBinder = b;</span><br><span class="line">            <span class="built_in">ALOGV</span>(<span class="string">&quot;Creating JavaBinder %p (refs %p) for Object %p, weakCount=%&quot;</span> PRId32 <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">                 b.<span class="built_in">get</span>(), b-&gt;<span class="built_in">getWeakRefs</span>(), obj, b-&gt;<span class="built_in">getWeakRefs</span>()-&gt;<span class="built_in">getWeakCount</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">sp&lt;JavaBBinder&gt; <span class="title">getExisting</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        AutoMutex _l(mLock);</span><br><span class="line">        <span class="keyword">return</span> mBinder.<span class="built_in">promote</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Mutex           mLock;</span><br><span class="line">    wp&lt;JavaBBinder&gt; mBinder;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>JavaBBinderHolder</code>的get函数返回的是个<code>JavaBBinder</code>对象，<code>JavaBBinder</code>对象内会有Java层的Binder对象。也就是说<code>addService</code>实际添加到<code>parcel</code>的并不是AMS本身，而是一个<code>JavaBBinder</code>对象，并最终传递到Binder驱动的也是这个<code>JavaBBinder</code>。</p>
<h4 id="2-1-分析JavaBBinder"><a href="#2-1-分析JavaBBinder" class="headerlink" title="2.1-分析JavaBBinder"></a>2.1-分析JavaBBinder</h4><blockquote>
<p>frameworks/base/core/jni/android_util_Binder.cpp</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JavaBBinder</span> :</span> <span class="keyword">public</span> BBinder</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">JavaBBinder</span>(JNIEnv* env, jobject <span class="comment">/* Java Binder */</span> object)</span><br><span class="line">        : <span class="built_in">mVM</span>(<span class="built_in">jnienv_to_javavm</span>(env)), <span class="built_in">mObject</span>(env-&gt;<span class="built_in">NewGlobalRef</span>(object))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ALOGV</span>(<span class="string">&quot;Creating JavaBBinder %p\n&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">        gNumLocalRefsCreated.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">        <span class="built_in">gcIfManyNewRefs</span>(env);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    JavaVM* <span class="keyword">const</span>   mVM;</span><br><span class="line">    jobject <span class="keyword">const</span>   mObject;  <span class="comment">// GlobalRef to Java Binder</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>从代码可以知<code>JavaBBinder</code>继承了<code>BBinder</code>,当Binder驱动的到客户的请求后，会将相应发送给<code>JavaBBinder</code>,这时会调用<code>JavaBBinder</code>的<code>onTransact</code>函数，代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">status_t</span> <span class="title">onTransact</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="keyword">uint32_t</span> flags = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      JNIEnv* env = <span class="built_in">javavm_to_jnienv</span>(mVM);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      IPCThreadState* thread_state = IPCThreadState::<span class="built_in">self</span>();</span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">int32_t</span> strict_policy_before = thread_state-&gt;<span class="built_in">getStrictModePolicy</span>();</span><br><span class="line"></span><br><span class="line">      jboolean res = env-&gt;<span class="built_in">CallBooleanMethod</span>(mObject, gBinderOffsets.mExecTransact,</span><br><span class="line">          code, <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(&amp;data), <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(reply), flags);</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">     </span><br><span class="line">      <span class="keyword">return</span> res != JNI_FALSE ? NO_ERROR : UNKNOWN_TRANSACTION;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>会调用Java层<code>Binder</code>的<code>execTransact</code>函数，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Entry point from android_util_Binder.cpp&#x27;s onTransact</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">execTransact</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">long</span> dataObj, <span class="keyword">long</span> replyObj,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    BinderCallsStats binderCallsStats = BinderCallsStats.getInstance();</span><br><span class="line">    BinderCallsStats.CallSession callSession = binderCallsStats.callStarted(<span class="keyword">this</span>, code);</span><br><span class="line">    Parcel data = Parcel.obtain(dataObj);</span><br><span class="line">    Parcel reply = Parcel.obtain(replyObj);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">boolean</span> res;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        res = onTransact(code, data, reply, flags);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException|RuntimeException e) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>execTransact</code>的关键代码就是调用<code>onTransact</code>方法，派生类可以实现<code>onTransact</code>方法，实现自己的业务代码，<code>ActivityManagerService</code>实现了自己的<code>onTransact</code>方法,如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);<span class="comment">//调用父类的onTransact</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        <span class="comment">// The activity manager only throws certain exceptions intentionally, so let&#x27;s</span></span><br><span class="line">        <span class="comment">// log all others.</span></span><br><span class="line">        <span class="keyword">if</span> (!(e <span class="keyword">instanceof</span> SecurityException</span><br><span class="line">                || e <span class="keyword">instanceof</span> IllegalArgumentException</span><br><span class="line">                || e <span class="keyword">instanceof</span> IllegalStateException)) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">&quot;Activity Manager Crash.&quot;</span></span><br><span class="line">                    + <span class="string">&quot; UID:&quot;</span> + Binder.getCallingUid()</span><br><span class="line">                    + <span class="string">&quot; PID:&quot;</span> + Binder.getCallingPid()</span><br><span class="line">                    + <span class="string">&quot; TRANS:&quot;</span> + code, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ActivityManagerService</code>继承IActivityManager.Stub类，该类是通过AIDL编译生成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IActivityManager</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">IInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/** Local-side IPC implementation stub class. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span></span></span><br><span class="line"><span class="class">		    <span class="keyword">implements</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">IActivityManager</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String DESCRIPTOR = <span class="string">&quot;android.app.IActivityManager&quot;</span>;</span><br><span class="line">        <span class="comment">/** Construct the stub at attach it to the interface. */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Stub</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Cast an IBinder object into an android.app.IActivityManager interface,</span></span><br><span class="line">         <span class="comment">// generating a proxy if needed.</span></span><br><span class="line">	    <span class="keyword">public</span> <span class="keyword">static</span> android.app.<span class="function">IActivityManager <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span></span></span><br><span class="line"><span class="function">	    </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ((obj==<span class="keyword">null</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</span><br><span class="line">            <span class="keyword">if</span> (((iin!=<span class="keyword">null</span>)&amp;&amp;(iin <span class="keyword">instanceof</span> android.app.IActivityManager))) &#123;</span><br><span class="line">                <span class="keyword">return</span> ((android.app.IActivityManager)iin);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> android.app.IActivityManager.Stub.Proxy(obj);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="meta">@Override</span> <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, </span></span></span><br><span class="line"><span class="params"><span class="function">		        android.os.Parcel data, android.os.Parcel reply,</span></span></span><br><span class="line"><span class="params"><span class="function">		        <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            java.lang.String descriptor = DESCRIPTOR;</span><br><span class="line">            <span class="keyword">switch</span> (code)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> INTERFACE_TRANSACTION:</span><br><span class="line">                &#123;</span><br><span class="line">                    reply.writeString(descriptor);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> TRANSACTION_startService:</span><br><span class="line">                &#123;</span><br><span class="line">                    data.enforceInterface(descriptor);</span><br><span class="line">                    IApplicationThread _arg0 = (IApplicationThread) data.readStrongBinder();</span><br><span class="line">                    Intent _arg1 = (Intent) data.readParcelable();</span><br><span class="line">                    java.lang.String _arg2 = data.readString();</span><br><span class="line">                    <span class="keyword">boolean</span> _arg3 = (<span class="number">0</span>!=data.readInt());</span><br><span class="line">                    java.lang.String _arg4 = data.readString();</span><br><span class="line">                    <span class="keyword">int</span> _arg5 = data.readInt();</span><br><span class="line">                    android.content.ComponentName _result = <span class="keyword">this</span>.startService(_arg0, _arg1,</span><br><span class="line">		                    _arg2, _arg3, _arg4, _arg5);</span><br><span class="line">                    reply.writeNoException();</span><br><span class="line">                    <span class="keyword">if</span> ((_result!=<span class="keyword">null</span>)) &#123;</span><br><span class="line">                        reply.writeInt(<span class="number">1</span>);</span><br><span class="line">                        _result.writeToParcel(reply,</span><br><span class="line">		                        android.os.Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        reply.writeInt(<span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> <span class="keyword">case</span> TRANSACTION_startActivity::</span><br><span class="line">                &#123;</span><br><span class="line">                    data.enforceInterface(DESCRIPTOR);</span><br><span class="line">                    android.app.IApplicationThread _arg0;</span><br><span class="line">                    _arg0 = android.app.IApplicationThread.Stub.asInterface(data.readStrongBinder());</span><br><span class="line">                    java.lang.String _arg1;</span><br><span class="line">                    _arg1 = data.readString();</span><br><span class="line">                    android.content.Intent _arg2;</span><br><span class="line">                    <span class="keyword">if</span> ((<span class="number">0</span>!=data.readInt())) &#123;</span><br><span class="line">                        _arg2 = android.content.Intent.CREATOR.createFromParcel(data);</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        _arg2 = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    java.lang.String _arg3;</span><br><span class="line">                    _arg3 = data.readString();</span><br><span class="line">                    android.os.IBinder _arg4;</span><br><span class="line">                    _arg4 = data.readStrongBinder();</span><br><span class="line">                    java.lang.String _arg5;</span><br><span class="line">                    _arg5 = data.readString();</span><br><span class="line">                    <span class="keyword">int</span> _arg6;</span><br><span class="line">                    _arg6 = data.readInt();</span><br><span class="line">                    <span class="keyword">int</span> _arg7;</span><br><span class="line">                    _arg7 = data.readInt();</span><br><span class="line">                    android.app.ProfilerInfo _arg8;</span><br><span class="line">                    <span class="keyword">if</span> ((<span class="number">0</span>!=data.readInt())) &#123;</span><br><span class="line">                    _arg8 = android.app.ProfilerInfo.CREATOR.createFromParcel(data);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                    _arg8 = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    android.os.Bundle _arg9;</span><br><span class="line">                    <span class="keyword">if</span> ((<span class="number">0</span>!=data.readInt())) &#123;</span><br><span class="line">                    _arg9 = android.os.Bundle.CREATOR.createFromParcel(data);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                    _arg9 = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">int</span> _result = <span class="keyword">this</span>.startActivity(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5, _arg6, _arg7, _arg8, _arg9);</span><br><span class="line">                    reply.writeNoException();</span><br><span class="line">                    reply.writeInt(_result);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">IActivityManager</span></span></span><br><span class="line"><span class="class">        </span>&#123;</span><br><span class="line">            <span class="keyword">private</span> android.os.IBinder mRemote;</span><br><span class="line">            Proxy(android.os.IBinder remote)</span><br><span class="line">            &#123;</span><br><span class="line">                mRemote = remote;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> mRemote;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getInterfaceDescriptor</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> DESCRIPTOR;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> android.content.<span class="function">ComponentName <span class="title">startService</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		            in IApplicationThread caller, in Intent service,</span></span></span><br><span class="line"><span class="params"><span class="function">		            java.lang.String resolvedType, <span class="keyword">boolean</span> requireForeground,</span></span></span><br><span class="line"><span class="params"><span class="function">		            java.lang.String callingPackage, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">		            <span class="keyword">throws</span> android.os.RemoteException</span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">                android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">                android.content.ComponentName _result;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">                    _data.writeStrongBinder(caller);</span><br><span class="line">                    _data.writeParcelable(service);</span><br><span class="line">                    _data.writeString(resolvedType);</span><br><span class="line">                    _data.writeInt(((requireForeground)?(<span class="number">1</span>):(<span class="number">0</span>)));</span><br><span class="line">                    _data.writeString(callingPackage);</span><br><span class="line">                    _data.writeInt(userId);</span><br><span class="line">                    mRemote.transact(Stub.TRANSACTION_startService, _data, _reply, <span class="number">0</span>);</span><br><span class="line">                    _reply.readException();</span><br><span class="line">                    <span class="keyword">if</span> ((<span class="number">0</span>!=_reply.readInt())) &#123;</span><br><span class="line">                        _result = android.content.ComponentName.CREATOR.createFromParcel(_reply);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        _result = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    _reply.recycle();</span><br><span class="line">                    _data.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> _result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_startService = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> android.content.<span class="function">ComponentName <span class="title">startService</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		    in IApplicationThread caller, in Intent service,</span></span></span><br><span class="line"><span class="params"><span class="function">		    java.lang.String resolvedType, <span class="keyword">boolean</span> requireForeground, </span></span></span><br><span class="line"><span class="params"><span class="function">		    java.lang.String callingPackage, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">		    <span class="keyword">throws</span> android.os.RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看出，<code>JavaBBinder</code>仅是个中间人，它本身没有任何业务函数，其中工作是：</p>
<ul>
<li>当它收到请求时，只是简单的调用它绑定的Java层Binder对象的exeTransact</li>
<li>该Binder对象的exeTransact调用其子类实现的onTransact函数</li>
<li>子类的onTransact函数将业务又分派个其子类来完成</li>
</ul>
<p><img src="/../images/AMS%E5%93%8D%E5%BA%94%E8%AF%B7%E6%B1%82%E7%9A%84%E8%BF%87%E7%A8%8B.png" alt="AMS响应请求过程"><br>PS：上图中虚线表示调用子类重载的方法<br>通过这种方式,来自客户端的请求就能传递到正确的Java Binder对象。</p>
<h3 id="3-Java层Binder架构总结"><a href="#3-Java层Binder架构总结" class="headerlink" title="3-Java层Binder架构总结"></a>3-Java层Binder架构总结</h3><p>Java层Binder架构简图如下所示：<br><img src="/../images/Java%E5%B1%82Binder%E6%9E%B6%E6%9E%84.png" alt="Java层Binder架构"></p>
<ol>
<li><code>BinderProxy</code>代表客户端，Java层<code>BinderProxy</code>在Native层对应着<code>BpBinder</code>。凡事从Java层发出的请求，先是从Java层<code>BinderProxy</code>传递给Native层的<code>BpBinder</code>，由<code>BpBinder</code>将请求发送给Binder驱动</li>
<li><code>Binder</code>代表服务端,<code>JavaBBinder</code>继承<code>BBinder</code>,<code>JavaBBinder</code>通过mObject指向Java层的<code>Binder</code>,<code>JavaBBinder</code>起到一个中转的作用，将来之客户端的请求从Native层传递到Java层。</li>
<li>在整个系统中只有一个服务关键 <code>ServiceManager</code></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wds1204.github.io/2022/01/18/Java%20Binder%E8%A7%A3%E6%9E%90/" data-id="cl0tpe0gf000dz9vha3oi9uay" class="article-share-link">
        分享
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Binder/" rel="tag">Binder</a></li></ul>

    </footer>

  </div>

  
  
<nav class="article-nav">
  
  <a href="/2022/01/26/%E7%94%A8%E5%8A%A8%E7%94%BB%E5%B8%A6%E4%BD%A0%E5%AD%A6%E4%B9%A0Git%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86/" class="article-nav-link">
    <strong class="article-nav-caption">前一篇</strong>
    <div class="article-nav-title">
      
      用动画带你学习Git原理
      
    </div>
  </a>
  
  
  <a href="/2022/01/17/Java%20Binder%E7%9A%84JNI%E6%B3%A8%E5%86%8C/" class="article-nav-link">
    <strong class="article-nav-caption">后一篇</strong>
    <div class="article-nav-title">Java Binder的JNI注册</div>
  </a>
  
</nav>

  

  
  
  
  

</article>
</section>
    <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
  <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
  <li><i class="fe fe-bookmark"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>modi.wu &copy; 2022</li>
      
        <li>WU</li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="modi.wu"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">相册</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        搜索
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/copybtn.js"></script>





<script src="/js/tocbot.min.js"></script>

<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
  });
</script>



<script src="/js/ocean.js"></script>

</body>

</html>