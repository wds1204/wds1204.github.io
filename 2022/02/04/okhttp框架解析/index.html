<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <title>
    okhttpæ¡†æ¶è§£æ |
    
    modi.wu
  </title>
  <!-- Icon -->
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <main class="content">
    <section class="outer">
  <article id="post-okhttpæ¡†æ¶è§£æ" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h1 class="article-title" itemprop="name">
    okhttpæ¡†æ¶è§£æ
  </h1>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/02/04/okhttp%E6%A1%86%E6%9E%B6%E8%A7%A3%E6%9E%90/" class="article-date">
  <time datetime="2022-02-03T16:25:41.000Z" itemprop="datePublished">2022-02-04</time>
</a>
      
<div class="article-category">
  <a class="article-category-link" href="/categories/android/">android</a> / <a class="article-category-link" href="/categories/okhttp/">okhttp</a>
</div>

    </div>
    

    
    
<div class="tocbot"></div>

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
        <p>ä½œä¸ºAndroidç¨‹åºå‘˜é™¤äº†Googleå®˜æ–¹æä¾›Androidæºç ï¼Œå¼€å‘é¡¹ç›®æ—¶è¿˜è¦ç”¨å¾ˆå¤šä¼˜ç§€çš„ä¸‰æ–¹å¼€æºåº“å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå¼€å‘ï¼ŒOKhttp3ä½œä¸ºsquareå¼€æºçš„ç½‘ç»œåº“ï¼Œå·²æˆAndroidç¨‹åºå‘˜å¿…ç”¨çš„ç½‘ç»œåº“ï¼Œå› ä¸ºå…¶ä¼˜ç§€çš„ä»£ç è®¾è®¡ã€å®Œå–„çš„ç½‘ç»œè¯·æ±‚åŠŸèƒ½ï¼Œä¹Ÿè¢«Googleæ”¶å…¥å®˜æ–¹æºç å®ç°ã€‚ä½œä¸ºå¼€å‘è€…å­¦ä¹ ä½œä¸ºç½‘ç»œçš„ç½‘ç»œæœ‰å¾ˆå¤šåˆ†æOkHttpçš„æ–‡ç« ï¼Œå¤§å¤šéƒ½æ˜¯è®²OkHttpçš„ä½¿ç”¨ã€æ¡†æ¶ç»“æ„ä»¥åŠè®¾è®¡æ¨¡å¼ç­‰è¿™äº›å†…å®¹ã€‚è€Œè¿™äº›åªæ˜¯OkHttpçš„ä¸€äº›æ‰‹æ®µå’Œæ–¹å¼ï¼Œå®ƒæœ¬è´¨ä¸Šä¸€ä¸ªç½‘ç»œè¯·æ±‚çš„åº“ï¼Œæˆ‘ä»¬é˜…è¯»æºç çš„æ—¶ï¼Œå®ç°åªä¸è¿‡æ˜¯ä¸ºäº†è¾¾åˆ°ç›®çš„ä¸€ç§æ–¹å¼ï¼Œè„±ç¦»ç›®çš„çš„å®ç°ï¼Œå¦‚ç¼˜æœ¨æ±‚é±¼ã€‚æ‰€ä»¥åœ¨åˆ†æOkHttpæºç çš„æ—¶ä¸€å®šè¦ç»“åˆhttpæœ¬èº«çš„ç‰¹æ€§ï¼Œä¸ç„¶å°±å¾ˆå®¹æ˜“åç¦»äº‹ç‰©æœ¬è´¨ã€‚</p>
<span id="more"></span>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">thread &#123;</span><br><span class="line">    <span class="keyword">val</span> socket = Socket(<span class="string">&quot;hencoder.com&quot;</span>, <span class="number">80</span>)</span><br><span class="line">    <span class="keyword">val</span> reader = BufferedReader(InputStreamReader(socket.getInputStream()))</span><br><span class="line">    <span class="keyword">val</span> writer = BufferedWriter(OutputStreamWriter(socket.getOutputStream()))</span><br><span class="line"></span><br><span class="line">    writer.write(<span class="string">&quot;GET / HTTP/1.1\nHost: hencoder.com\n\n&quot;</span>)</span><br><span class="line">    writer.flush()</span><br><span class="line"></span><br><span class="line">    println(</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">         <span class="subst">$&#123;reader.readText()&#125;</span></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>.trimIndent()</span><br><span class="line">          )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç æ˜¯é€šè¿‡Socketå®ç°ä¸€ä¸ªç®€å•çš„ç½‘ç»œè¿æ¥ï¼Œè€Œä¸”æ˜¯éå¸¸ç®€é™‹ã€‚æœ‰å¾ˆå¤šå†…å®¹æ²¡æœ‰è€ƒè™‘åˆ°ï¼Œæ¯”å¦‚Http2ã€SSLã€ä»£ç†ã€é‡å®šå‘ã€é”™è¯¯é‡è¯•ç­‰å†…å®¹ã€‚å¦‚æœæŠŠhttpè¯·æ±‚çš„å„ç§æƒ…å†µéƒ½è€ƒè™‘è¿›å»ï¼Œç„¶åè‡ªå·±åŠ¨æ‰‹æ’¸ä¸ªæ¡†æ¶ï¼Œè¿™å·¥ä½œé‡è¿˜æ˜¯å¾ˆå¤§ã€‚OKHttpå°±æ˜¯è¿™æ ·ä»æœ€åº•å±‚çš„ç½‘ç»œè¿æ¥åˆ°Httpçš„å„ç§é€‚é…ï¼Œåº•æœå¤©çš„å®Œå…¨è‡ªå·±å®ç°äº†ä¸€éï¼Œè€Œä¸”</p>
<p>çœ‹æºç ä¹‹å‰ï¼Œå…ˆä»æœ€ç®€å•OkHttpçš„ä½¿ç”¨å¼€å§‹</p>
<h3 id="OkHttpä½¿ç”¨æ–¹æ³•ç®€ä»‹"><a href="#OkHttpä½¿ç”¨æ–¹æ³•ç®€ä»‹" class="headerlink" title="OkHttpä½¿ç”¨æ–¹æ³•ç®€ä»‹"></a>OkHttpä½¿ç”¨æ–¹æ³•ç®€ä»‹</h3><ol>
<li><p>åˆ›å»ºä¸€ä¸ªOkHttpClientå®ä¾‹</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> client=OkHttpClient.Builder().build()</span><br></pre></td></tr></table></figure></li>
<li><p>åˆ›å»ºRequest</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> url = <span class="string">&quot;https://api.github.com/users/wds1204/repos&quot;</span></span><br><span class="line"><span class="keyword">val</span> request: Request = Request.Builder()</span><br><span class="line">          .url(url)</span><br><span class="line">          .build()</span><br></pre></td></tr></table></figure></li>
<li><p>åˆ›å»ºCallå¹¶å‘èµ·ç½‘ç»œè¯·æ±‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¼‚æ­¥è¯·æ±‚</span></span><br><span class="line"><span class="keyword">val</span> newCall:Call=client.newCall(request)</span><br><span class="line">client.newCall(request).enqueue(<span class="keyword">object</span> : Callback &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(call: <span class="type">Call</span>, e: <span class="type">IOException</span>)</span></span> &#123;&#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResponse</span><span class="params">(call: <span class="type">Call</span>, response: <span class="type">Response</span>)</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;okhttp response  <span class="subst">$&#123;response.code&#125;</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>åˆ†åˆ«æ„å»º<code>OkHttpClient</code>ã€<code>Request</code>,ç„¶åè°ƒç”¨<code>OkHttpClient</code>çš„<code>newCall</code>,<code>Request</code>ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œè¿”å›ä¸€ä¸ª<code>Call</code>å¯¹åƒã€‚æœ€ç»ˆè°ƒ<code>Call</code>çš„<code>enqueue</code>æ–¹æ³•,æˆåŠŸå›è°ƒ<code>onResponse</code>ï¼Œå¤±è´¥å›è°ƒ<code>onFailure</code>ã€‚</p>
</li>
</ol>
<h3 id="OkHttpæºç åˆ†æ"><a href="#OkHttpæºç åˆ†æ" class="headerlink" title="OkHttpæºç åˆ†æ"></a>OkHttpæºç åˆ†æ</h3><blockquote>
<p>okhttpæºç ç‰ˆæœ¬: 4.9.0</p>
</blockquote>
<p> åœ¨ä¸Šä¸€å°èŠ‚ä¸­ä»‹ç»äº†okHttpä½¿ç”¨ï¼Œå¯ä»¥çœ‹å‡ºæ•´ä¸ªæµç¨‹å¾ˆç®€è€Œä¸”ä¹Ÿå®¹æ˜“å•ä¸Šæ‰‹åˆ†ã€‚å…¶ä¸­<code>OkHttpClient</code>ã€<code>Request</code>éƒ½æ˜¯é€šè¿‡Buildæ¨¡å¼æ„å»º,ä¸€ä¸ªå®¢æˆ·ç«¯å¯¹è±¡ã€ä¸€ä¸ªè¯·æ±‚çš„é…ç½®ï¼Œå…³é”®ç‚¹æ˜¯åœ¨<code>newCall</code>æ–¹æ³•,è¿›å…¥æ–¹æ³•å†…éƒ¨ï¼š</p>
<blockquote>
<p>OkHttpClient</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newCall</span><span class="params">(request: <span class="type">Request</span>)</span></span>: Call = RealCall(<span class="keyword">this</span>, request, forWebSocket = <span class="literal">false</span>)</span><br></pre></td></tr></table></figure>
<p>å¼•å‡ºRealCallå¯¹è±¡ã€‚</p>
<h4 id="RealCall"><a href="#RealCall" class="headerlink" title="RealCall"></a>RealCall</h4><p> newCallè¿”å›çš„RealCallå¯¹è±¡ï¼Œä¼šæŠŠæ­¤å‰æ„å»º<code>OkHttpClient</code>ã€<code>Requestcan</code>å¯¹è±¡ç”¨äºåˆ›å»º<code>RealCall</code>,å¤–è¿˜æœ‰<code>forWebSocket</code>å‚æ•°ï¼Œæ˜¯ç”¨æ¥æ˜¯å¦æ”¯æŒ<code>webSocket</code>åè®®çš„ï¼Œæœ¬äººå¯¹webSocketäº†è§£çš„ä¹Ÿä¸å¤Ÿ,æ„Ÿå…´è¶£è¯·è‡ªè¡ŒæŸ¥é˜…ã€‚æ¥ä¸‹æ¥ä¼šè°ƒç”¨<code>RealCall</code>çš„<code>enqueue</code>è¿™ä¸ªå¼‚æ­¥è¯·æ±‚æ–¹æ³•ã€‚</p>
<blockquote>
<p>RealCall</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">enqueue</span><span class="params">(responseCallback: <span class="type">Callback</span>)</span></span> &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  callStart()</span><br><span class="line">  client.dispatcher.enqueue(AsyncCall(responseCallback))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>callStart()</li>
<li>client.dispatcher.enqueue(AsyncCall(responseCallback))</li>
</ul>
<p>callStartè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥è§¦å‘ç›‘å¬çš„</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">callStart</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.callStackTrace = Platform.<span class="keyword">get</span>().getStackTraceForCloseable(<span class="string">&quot;response.body().close()&quot;</span>)</span><br><span class="line">  eventListener.callStart(<span class="keyword">this</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="EventListener"><a href="#EventListener" class="headerlink" title="EventListener"></a>EventListener</h4><p>åœ¨æ„å»ºOkHttpClientçš„æ—¶å€™å¯ä»¥é€šè¿‡eventListeneræˆ–è€…eventListenerFactoryæ–¹æ³•æ·»åŠ EventListenerç›‘å¬ã€‚å¯ä»¥ç”¨å®ƒåšhttpçš„ç½‘ç»œç›‘æ§ï¼Œæ¯”å¦‚dnsæŸ¥è¯¢è€—æ—¶ã€socket connnectè€—æ—¶ã€tlsè¿æ¥è€—æ—¶ã€è¯·æ±‚å‘é€è€—æ—¶ã€å“åº”ä¼ è¾“è€—æ—¶ã€å“åº”è§£æè€—æ—¶ã€‚åé¢é‡åˆ°æ­¤ç±»çš„å°±çŸ¥é“æ˜¯ä»€ä¹ˆæ¶µä¹‰äº†ã€‚<br><img src="/../images/okhttp/Eventlistener.png" alt="image.png"><br>â€‹<br><code>client.dispatcher.enqueue(AsyncCall(responseCallback))</code> è°ƒç”¨OkHttpClientä¸­dispatchè°ƒåº¦å™¨çš„enqueueæ–¹æ³•ã€‚dispatchä¸€çœ‹åå­—å°±åº”è¯¥æƒ³åˆ°å’Œçº¿ç¨‹æ± ç›¸å…³ï¼Œ</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">enqueue</span><span class="params">(call: <span class="type">AsyncCall</span>)</span></span> &#123;</span><br><span class="line">  synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">    readyAsyncCalls.add(call)<span class="comment">//1æŠŠAsyncCallæ·»åŠ åˆ°readyAsyncCallsåŒå‘é˜Ÿåˆ—ä¸­</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Mutate the AsyncCall so that it shares the AtomicInteger of an existing running call to</span></span><br><span class="line">    <span class="comment">// the same host.</span></span><br><span class="line">    <span class="keyword">if</span> (!call.call.forWebSocket) &#123;</span><br><span class="line">      <span class="keyword">val</span> existingCall = findExistingCallWithHost(call.host)<span class="comment">//2</span></span><br><span class="line">      <span class="keyword">if</span> (existingCall != <span class="literal">null</span>) call.reuseCallsPerHostFrom(existingCall)<span class="comment">//3</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  promoteAndExecute()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨é‡Š1<code>AsyncCall</code>æ·»åŠ åˆ°<code>readyAsyncCalls</code>åŒå‘é˜Ÿåˆ—ä¸­ã€‚æ³¨å°„2å¤„æ‰¾åˆ°ç›¸åº”<code>host</code>çš„<code>AsyncCall</code>ï¼Œåœ¨æ³¨å°„3å¤„ä¼šé‡ç”¨ä¸Šä¸€ä¸ª<code>AsyncCall</code>çš„<code>callsPerHost</code>ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">inner</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCall</span></span>( <span class="keyword">private</span> <span class="keyword">val</span> responseCallback: Callback ) : Runnable &#123;</span><br><span class="line">  <span class="meta">@Volatile</span> <span class="keyword">var</span> callsPerHost = AtomicInteger(<span class="number">0</span>)</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">set</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">reuseCallsPerHostFrom</span><span class="params">(other: <span class="type">AsyncCall</span>)</span></span> &#123;</span><br><span class="line">     <span class="keyword">this</span>.callsPerHost = other.callsPerHost</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Œæ¯ä¸ªå¼‚æ­¥è¯·æ±‚éƒ½ä¼šæ”¾åˆ°<code>AsyncCall</code>ä¸­ï¼Œ<code>callsPerHost</code>æ˜¯ä¸ª<code>AtomicInterger</code>ï¼Œæ¯æ¬¡æ‰§è¡Œ<code>promoteAndExecute</code>ä¼šè°ƒç”¨<code>incrementAndGet</code>ï¼Œå¼‚æ­¥ä»»åŠ¡æˆåŠŸæ‰§è¡Œåè°ƒç”¨<code>decrementAndGet</code>ã€‚ä¿æŒ<code>callsPerHost</code>ä¸­çš„Intä¸º0ã€‚å°±æ˜¯ä¸ºäº†æ ‡è®°åŒä¸€ä¸ªä¸»æœºè®¿é—®çš„æ¬¡æ•°ã€‚</p>
<p>ç»“åˆ<code>promoteAndExecute</code>æ–¹æ³•ä¼šçœ‹çš„æ›´æ¸…æ™°ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">promoteAndExecute</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.assertThreadDoesntHoldLock()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> executableCalls = mutableListOf&lt;AsyncCall&gt;()</span><br><span class="line">  <span class="keyword">val</span> isRunning: <span class="built_in">Boolean</span></span><br><span class="line">  synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> i = readyAsyncCalls.iterator()</span><br><span class="line">    <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">      <span class="keyword">val</span> asyncCall = i.next()</span><br><span class="line">    <span class="comment">//maxRequests=64 å¹¶å‘æ‰§è¡Œçš„æœ€å¤§è¯·æ±‚æ•°</span></span><br><span class="line">      <span class="keyword">if</span> (runningAsyncCalls.size &gt;= <span class="keyword">this</span>.maxRequests) <span class="keyword">break</span> <span class="comment">// Max capacity.</span></span><br><span class="line">       <span class="comment">//maxRequestsPerHost=4ï¼Œé€šè¿‡ä¸»æœºçš„æœ€å¤§è¯·æ±‚æ•°å¹¶å‘æ‰§è¡Œï¼Œå¦‚æœå¤§äºç­‰äº4å°±ç›´æ¥continue</span></span><br><span class="line">      <span class="keyword">if</span> (asyncCall.callsPerHost.<span class="keyword">get</span>() &gt;= <span class="keyword">this</span>.maxRequestsPerHost) <span class="keyword">continue</span> <span class="comment">// Host max capacity.</span></span><br><span class="line"></span><br><span class="line">      i.remove()</span><br><span class="line">      asyncCall.callsPerHost.incrementAndGet()</span><br><span class="line">      executableCalls.add(asyncCall)<span class="comment">//å­˜æ”¾åœ¨å¯æ‰§è¡Œçš„é›†åˆä¸­</span></span><br><span class="line">      runningAsyncCalls.add(asyncCall)<span class="comment">//å­˜åœ¨åœ¨runningAsyncCallsåŒå‘é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    &#125;</span><br><span class="line">    isRunning = runningCallsCount() &gt; <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until executableCalls.size) &#123;</span><br><span class="line">    <span class="keyword">val</span> asyncCall = executableCalls[i]</span><br><span class="line">    asyncCall.executeOn(executorService)<span class="comment">//è°ƒç”¨AsyncCallçš„executeOn,ExecutorServiceä¸ºçº¿ç¨‹æ± </span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> isRunning</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AsyncCall"><a href="#AsyncCall" class="headerlink" title="AsyncCall"></a>AsyncCall</h4><p>æ¯æ¬¡è°ƒç”¨<code>RealCall</code>çš„<code>enqueue</code>éƒ½ä¼šåˆ›å»ºä¸€ä¸ª<code>AsyncCall</code>,å®ƒæ˜¯æ˜¯<code>RealCall</code>çš„å†…éƒ¨ç±»ï¼Œå®ç°<code>Runnable</code>æ¥å£ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">inner</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCall</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> responseCallback: Callback</span><br><span class="line">  ) : Runnable &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">executeOn</span><span class="params">(executorService: <span class="type">ExecutorService</span>)</span></span> &#123;</span><br><span class="line">      client.dispatcher.assertThreadDoesntHoldLock()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> success = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        executorService.execute(<span class="keyword">this</span>)<span class="comment">//è°ƒç”¨executeï¼Œæœ€ç»ˆå›è°ƒAsyncCallçš„runæ–¹æ³•</span></span><br><span class="line">        success = <span class="literal">true</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (e: RejectedExecutionException) &#123;</span><br><span class="line">        <span class="comment">//å‘ç”Ÿå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">val</span> ioException = InterruptedIOException(<span class="string">&quot;executor rejected&quot;</span>)</span><br><span class="line">        ioException.initCause(e)</span><br><span class="line">        noMoreExchanges(ioException)</span><br><span class="line">        responseCallback.onFailure(<span class="keyword">this</span><span class="symbol">@RealCall</span>, ioException)</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">          client.dispatcher.finished(<span class="keyword">this</span>) <span class="comment">// This call is no longer running!</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å›è°ƒAsyncCallçš„runæ–¹æ³•ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">inner</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCall</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> responseCallback: Callback</span><br><span class="line">  ) : Runnable &#123;   </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">	<span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">      threadName(<span class="string">&quot;OkHttp <span class="subst">$&#123;redactedUrl()&#125;</span>&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> signalledCallback = <span class="literal">false</span></span><br><span class="line">        timeout.enter()</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//æ‹¿åˆ°å“åº”çš„response</span></span><br><span class="line">          <span class="keyword">val</span> response = getResponseWithInterceptorChain()</span><br><span class="line">          signalledCallback = <span class="literal">true</span></span><br><span class="line">          <span class="comment">//å›è°ƒresponseCallback.onResponse</span></span><br><span class="line">          responseCallback.onResponse(<span class="keyword">this</span><span class="symbol">@RealCall</span>, response)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: IOException) &#123;</span><br><span class="line">          <span class="keyword">if</span> (signalledCallback) &#123;</span><br><span class="line">            <span class="comment">// Do not signal the callback twice!</span></span><br><span class="line">            Platform.<span class="keyword">get</span>().log(<span class="string">&quot;Callback failure for <span class="subst">$&#123;toLoggableString()&#125;</span>&quot;</span>, Platform.INFO, e)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            responseCallback.onFailure(<span class="keyword">this</span><span class="symbol">@RealCall</span>, e)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (t: Throwable) &#123;</span><br><span class="line">          cancel()</span><br><span class="line">          <span class="keyword">if</span> (!signalledCallback) &#123;</span><br><span class="line">            <span class="keyword">val</span> canceledException = IOException(<span class="string">&quot;canceled due to <span class="variable">$t</span>&quot;</span>)</span><br><span class="line">            canceledException.addSuppressed(t)</span><br><span class="line">            responseCallback.onFailure(<span class="keyword">this</span><span class="symbol">@RealCall</span>, canceledException)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">throw</span> t</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          client.dispatcher.finished(<span class="keyword">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="getResponseWithInterceptorChain"><a href="#getResponseWithInterceptorChain" class="headerlink" title="getResponseWithInterceptorChain"></a>getResponseWithInterceptorChain</h4><p>é€šè¿‡<code>getResponseWithInterceptorChain</code>æ–¹æ³•æ‹¿åˆ°è¿™æ¬¡è¯·æ±‚çš„<code>response</code>ï¼Œç„¶åå›è°ƒ<code>responseCallback</code>çš„<code>onResponse</code>ï¼Œå¦‚æœå¤±è´¥å›è°ƒ<code>onFailure</code>ã€‚è¿™é‡Œçš„<code>responseCallback</code>å°±æ˜¯è°ƒç”¨<code>RealCall</code>ä¼ å…¥æ¥çš„<code>CallBack</code>ã€‚åˆ°è¿™é‡Œæ•´ä¸ªç½‘ç»œè¯·æ±‚å°±ç»“æŸäº†ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰å°±è¿™ğŸ¤”ï¸Socketçš„è¿æ¥å‘¢ğŸ¤”ï¸TSLè¿æ¥ğŸ¤”ï¸æŠ¥æ–‡å‘é€å’Œæ¥æ”¶å“åº”ğŸ¤”ï¸æ‰€æœ‰çš„è¿™äº›ä¸œè¥¿éƒ½åŒ…å«åœ¨<code>getResponseWithInterceptorChain</code>æ–¹æ³•ä¸­ï¼Œä¹Ÿå°±å¤§å®¶è¯´åˆ°OkHttpçš„æ—¶å€™éƒ½ä¼šæçš„æ‹¦æˆªå™¨æ¨¡å¼ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">getResponseWithInterceptorChain</span><span class="params">()</span></span>: Response &#123;</span><br><span class="line">    <span class="comment">// Build a full stack of interceptors.</span></span><br><span class="line">    <span class="comment">/*======== 1ã€æ·»åŠ æ‹¦æˆªå™¨ ========*/</span></span><br><span class="line">    <span class="keyword">val</span> interceptors = mutableListOf&lt;Interceptor&gt;()</span><br><span class="line">    interceptors += client.interceptors</span><br><span class="line">    interceptors += RetryAndFollowUpInterceptor(client)</span><br><span class="line">    interceptors += BridgeInterceptor(client.cookieJar)</span><br><span class="line">    interceptors += CacheInterceptor(client.cache)</span><br><span class="line">    interceptors += ConnectInterceptor</span><br><span class="line">    <span class="keyword">if</span> (!forWebSocket) &#123;</span><br><span class="line">      interceptors += client.networkInterceptors</span><br><span class="line">    &#125;</span><br><span class="line">    interceptors += CallServerInterceptor(forWebSocket)</span><br><span class="line">	<span class="comment">//1ã€æ„å»ºæ‹¦æˆªå™¨é“¾RealInterceptorChain</span></span><br><span class="line">    <span class="keyword">val</span> chain = RealInterceptorChain(</span><br><span class="line">        call = <span class="keyword">this</span>,</span><br><span class="line">        interceptors = interceptors,</span><br><span class="line">        index = <span class="number">0</span>,</span><br><span class="line">        exchange = <span class="literal">null</span>,</span><br><span class="line">        request = originalRequest,</span><br><span class="line">        connectTimeoutMillis = client.connectTimeoutMillis,</span><br><span class="line">        readTimeoutMillis = client.readTimeoutMillis,</span><br><span class="line">        writeTimeoutMillis = client.writeTimeoutMillis</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> calledNoMoreExchanges = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//3ã€å¼€å¯é“¾å¼å·¥ä½œ</span></span><br><span class="line">      <span class="keyword">val</span> response = chain.proceed(originalRequest)</span><br><span class="line">      <span class="keyword">if</span> (isCanceled()) &#123;</span><br><span class="line">        response.closeQuietly()</span><br><span class="line">        <span class="keyword">throw</span> IOException(<span class="string">&quot;Canceled&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> response</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: IOException) &#123;</span><br><span class="line">      calledNoMoreExchanges = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">throw</span> noMoreExchanges(e) <span class="keyword">as</span> Throwable</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!calledNoMoreExchanges) &#123;</span><br><span class="line">        noMoreExchanges(<span class="literal">null</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»º<code>RealInterceptorChain</code>å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«å„ç§æ‹¦æˆªï¼ˆå†…ç½®ã€è‡ªå®šä¹‰ï¼‰ï¼Œç„¶åè°ƒç”¨<code>RealInterceptorChain</code>çš„p<code>roceed</code>æ–¹æ³•è§¦å‘é“¾å¼å·¥ä½œã€‚<br>â€‹</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">proceed</span><span class="params">(request: <span class="type">Request</span>)</span></span>: Response &#123;</span><br><span class="line">  check(index &lt; interceptors.size)</span><br><span class="line"></span><br><span class="line">  calls++</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (exchange != <span class="literal">null</span>) &#123;</span><br><span class="line">    check(exchange.finder.sameHostAndPort(request.url)) &#123;</span><br><span class="line">      <span class="string">&quot;network interceptor <span class="subst">$&#123;interceptors[index - <span class="number">1</span>]&#125;</span> must retain the same host and port&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    check(calls == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="string">&quot;network interceptor <span class="subst">$&#123;interceptors[index - <span class="number">1</span>]&#125;</span> must call proceed() exactly once&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call the next interceptor in the chain.</span></span><br><span class="line">  <span class="keyword">val</span> next = copy(index = index + <span class="number">1</span>, request = request)</span><br><span class="line">  <span class="keyword">val</span> interceptor = interceptors[index]</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Suppress(<span class="meta-string">&quot;USELESS_ELVIS&quot;</span>)</span></span><br><span class="line">  <span class="keyword">val</span> response = interceptor.intercept(next) ?: <span class="keyword">throw</span> NullPointerException(</span><br><span class="line">      <span class="string">&quot;interceptor <span class="variable">$interceptor</span> returned null&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (exchange != <span class="literal">null</span>) &#123;</span><br><span class="line">    check(index + <span class="number">1</span> &gt;= interceptors.size || next.calls == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="string">&quot;network interceptor <span class="variable">$interceptor</span> must call proceed() exactly once&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  check(response.body != <span class="literal">null</span>) &#123; <span class="string">&quot;interceptor <span class="variable">$interceptor</span> returned a response with no body&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> response</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code> val next = copy(index = index + 1, request = request)</code> æŠŠ<code>RealInterceptorChain</code>å½“å‰<code>interceptors</code>çš„indexå‰ç§»ä¸€ä½ã€‚<br><code>val interceptor = interceptors[index]</code>æ‰¾åˆ°å½“å‰çš„interceptorï¼Œç„¶åè°ƒç”¨<code>interceptor</code>çš„<code>intercept</code>æ–¹æ³•å¤„å…·ä½“çš„æ‹¦æˆªå™¨æ–¹æ³•ã€‚åˆšè§¦å‘é“¾è¡¨å·¥ä½œæ—¶ï¼Œå¦‚æœæœ‰æ²¡æ·»åŠ è‡ªå®šä¹‰æ‹¦æˆªå™¨åˆ°<code>interceptors</code>çš„,ç¬¬ä¸€ä¸ªè¿è¡Œæ‹¦æˆªå™¨å°±æ˜¯<code>RetryAndFollowUpInterceptor</code>ã€‚</p>
<blockquote>
<p>RetryAndFollowUpInterceptor</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">intercept</span><span class="params">(chain: <span class="type">Interceptor</span>.<span class="type">Chain</span>)</span></span>: Response &#123;</span><br><span class="line">    <span class="keyword">val</span> realChain = chain <span class="keyword">as</span> RealInterceptorChain</span><br><span class="line">    <span class="keyword">var</span> request = chain.request</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="comment">//...      </span></span><br><span class="line">      response = realChain.proceed(request)</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      <span class="keyword">return</span> response</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>RetryAndFollowUpInterceptor</code>çš„<code>intercept</code>æ–¹æ³•å†…åˆä¼šè°ƒç”¨<code>RealInterceptorChain</code>çš„<code>proceed</code>æ–¹æ³•ã€‚æ­¤æ—¶<code>RealInterceptorChain</code>ä¸­çš„<code>interceptors</code>çš„indexå·²ç»å¾€å‰ç§»äº†ä¸€ä½ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæœ€åä¸€ç›´æ‰§è¡Œåˆ°æœ€åä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œç„¶åä»¥å¾€å‰ä¼ é€’å½“å‰æ‹¦æˆªå™¨çš„``response`<br>ä¹‹æ‰€ä»¥æŠŠOkHttpçš„æ‹¦æˆªå™¨è®¾è®¡æˆä¸‰ä¸ªæ­¥éª¤ï¼šè§¦å‘å‰æ®µã€è§¦å‘æ‹¦æˆªå™¨ã€è§¦å‘åæ®µã€‚åº”è¯¥æ˜¯è€ƒè™‘åˆ°ç½‘ç»œè¯·æ±‚çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬é€šè¿‡éœ€è¦åœ¨è¯·æ±‚å‰å’Œè¯·æ±‚ååˆ†åˆ«åšä¸€äº›å¹²é¢„æ“ä½œï¼Œè¿™æ ·è®¾è®¡ä¾¿äºå¤„ç†ã€‚ä¸‹é¢ç»™å‡ºä¸€å¼ æ‹¦æˆªå™¨æµç¨‹å›¾:</p>
<p><img src="/../images/okhttp/interceptor.png" alt="interceptor.png"></p>
<h3 id="OKHttpé…ç½®ç®€ä»‹"><a href="#OKHttpé…ç½®ç®€ä»‹" class="headerlink" title="OKHttpé…ç½®ç®€ä»‹"></a>OKHttpé…ç½®ç®€ä»‹</h3><p>è¡¥å……ä¸€ä¸‹<code>OKHttpClient</code>ç›¸å…³å†…å®¹ï¼Œå®ƒç›¸å½“äºé…ç½®ä¸­å¿ƒï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šå…±äº«è¿™äº›é…ç½®(ä¾‹å¦‚å‡ºé”™æ˜¯å¦é‡æ‹¾ã€å…±äº«çš„è¿æ¥æ± )ã€‚<code>OkHttpClient</code>ä¸­é…ç½®ä¸»è¦æœ‰ï¼š</p>
<ul>
<li><code>dispatcher: Dispatcher</code>:è°ƒç”¨å™¨ï¼Œç”¨äºè°ƒåº¦åå°å‘èµ·çš„ç½‘è·¯è¯·æ±‚ï¼Œæœ‰åå°æ€»è¯·æ±‚æ•°å’Œå•ä¸»æœºæ€»è¯·æ±‚æ•°çš„æ§åˆ¶ã€‚</li>
<li><code>protocols: List&lt;Protocol&gt;</code>: æ”¯æŒçš„åº”ç”¨å±‚åè®®ï¼Œå³HTTP/1.1ã€HTTP/2ç­‰ã€‚</li>
<li><code>connectionSpecs: List&lt;ConnectionSpec&gt;</code>: åº”ç”¨å±‚æ”¯æŒçš„Socketè®¾ç½®ï¼Œå³ä½¿ç”¨æ˜æ–‡ä¼ è¾“(HTTP)ï¼Œè¿˜æ˜¯æŸä¸ªç‰ˆæœ¬çš„TLS(HTTPS)</li>
<li><code>interceptors: List&lt;Interceptor&gt;</code>:æ‹¦æˆªå™¨ï¼Œå¤§å¤šæ•°æ—¶å€™ä½¿ç”¨çš„ Interceptor éƒ½åº”è¯¥é…ç½®åˆ°è¿™é‡Œã€‚</li>
<li><code>networkInterceptors: List&lt;Interceptor&gt;</code>:ç›´æ¥å’Œç½‘ç»œè¯·æ±‚äº¤äº’çš„ Interceptor é…ç½®åˆ°è¿™é‡Œï¼Œä¾‹å¦‚å¦‚æœä½ æƒ³æŸ¥çœ‹è¿”å›çš„ 301æŠ¥æ–‡æˆ–è€…æœªè§£å‹çš„<code>Response Body</code>ï¼Œéœ€è¦åœ¨è¿™é‡Œçœ‹ã€‚</li>
<li><code>cookieJar: CookieJar</code>:ç®¡ç†Cookieçš„æ§åˆ¶å™¨ï¼ŒOkHttpæä¾›äº†å¯¹<code>Cookie</code>å­˜å–çš„æ”¯æŒ,ä½†æ²¡æœ‰ç»™å‡ºå…·ä½“çš„å­˜å–å®ç°ï¼Œé»˜è®¤æ˜¯ä¸ª<code>NO_COOKIES</code>,å¦‚æœéœ€è¦å­˜å– Cookieï¼Œä½ å¾—è‡ªå·±å®Œæˆå®ç°ã€‚</li>
<li><code>cache: Cache</code>:Cacheçš„é»˜è®¤çš„é…ç½®ä¹Ÿæ˜¯æ²¡æœ‰çš„ï¼Œå¦‚æœéœ€è¦éœ€è‡ªå·±é…ç½®Cacheå­˜å‚¨æ–‡ä»¶çš„ä½ç½®ã€å­˜å‚¨ç©ºé—´çš„ä¸Šçº¿ä»¥åŠç¼“å­˜ç­–ç•¥ã€‚</li>
<li><code>hostnameVerifier: HostnameVerifier</code>:ç”¨äºéªŒè¯HTTPSæ¡æ‰‹è¿‡ç¨‹ä¸‹è½½çš„è¯ä¹¦æ‰€å±è€…æ˜¯å¦å’Œè‡ªå·±è¦è®¿é—®çš„ä¸»æœºåŸŸåæ˜¯å¦ä¸€è‡´ã€‚</li>
<li><code>hostnameVerifier: HostnameVerifier</code> :ç”¨äºéªŒè¯ HTTPS æ¡æ‰‹è¿‡ç¨‹ ä¸­ä¸‹è½½åˆ°çš„è¯ä¹¦æ‰€å±è€…æ˜¯å¦å’Œè‡ªå·±è¦è®¿é—®çš„ä¸»æœºåä¸€è‡´ã€‚</li>
<li><code>certificatePinner: CertificatePinner</code> :ç”¨äºè®¾ç½® HTTPS æ¡æ‰‹ è¿‡ç¨‹ä¸­é’ˆå¯¹æŸä¸ª Host é¢å¤–çš„çš„ Certificate Public Key Pinnerï¼Œå³æŠŠç½‘ç«™è¯ ä¹¦é“¾ä¸­çš„æ¯ä¸€ä¸ªè¯ä¹¦å…¬é’¥ç›´æ¥æ‹¿æ¥æå‰é…ç½®è¿› OkHttpClient é‡Œå»ï¼Œä½œä¸ºæ­£ å¸¸çš„è¯ä¹¦éªŒè¯æœºåˆ¶ä¹‹å¤–çš„ä¸€æ¬¡é¢å¤–éªŒè¯ã€‚</li>
<li><code>authenticator: Authenticator</code> :ç”¨äºè‡ªåŠ¨é‡æ–°è®¤è¯ã€‚é…ç½®ä¹‹åï¼Œåœ¨ è¯·æ±‚æ”¶åˆ° 401 çŠ¶æ€ç çš„å“åº”æ˜¯ï¼Œä¼šç›´æ¥è°ƒç”¨ authenticator ï¼Œæ‰‹åŠ¨åŠ  å…¥ Authorization header ä¹‹åè‡ªåŠ¨é‡æ–°å‘èµ·è¯·æ±‚ã€‚</li>
<li><code>followRedirects: boolean</code> :é‡åˆ°é‡å®šå‘çš„è¦æ±‚æ˜¯ï¼Œæ˜¯å¦è‡ªåŠ¨ followã€‚</li>
<li><code>followSslRedirects: boolean</code>: åœ¨é‡å®šå‘æ—¶ï¼Œå¦‚æœåŸå…ˆè¯·æ±‚çš„æ˜¯httpè€Œé‡å®šå‘çš„ç›®æ ‡æ˜¯httpsï¼Œæˆ–è€…åŸå…ˆè¯·æ±‚çš„æ˜¯ https è€Œé‡å®šå‘çš„ç›®æ ‡æ˜¯ httpï¼Œæ˜¯å¦ä¾ç„¶è‡ªåŠ¨ followã€‚(è®°å¾—ï¼Œä¸æ˜¯ã€Œæ˜¯å¦è‡ªåŠ¨ follow HTTPS URLé‡å®šå‘çš„æ„æ€ï¼Œè€Œæ˜¯æ˜¯å¦è‡ªåŠ¨ follow åœ¨ HTTP å’Œ HTTPS ä¹‹é—´åˆ‡æ¢çš„é‡å®š å‘)</li>
<li><code>retryOnConnectionFailure: boolean</code>:åœ¨è¯·æ±‚å¤±è´¥çš„æ—¶å€™æ˜¯å¦è‡ªåŠ¨é‡è¯•ã€‚æ³¨æ„ï¼Œå¤§å¤šæ•°çš„è¯·æ±‚å¤±è´¥å¹¶ä¸å±äº OkHttp æ‰€å®šä¹‰çš„ã€Œéœ€è¦é‡è¯•ã€ï¼Œè¿™ç§é‡è¯•åªé€‚ç”¨äºã€ŒåŒä¸€ä¸ªåŸŸåçš„å¤šä¸ª IP åˆ‡æ¢é‡è¯•ã€ã€ŒSocket å¤±æ•ˆé‡è¯•ã€ç­‰æƒ…å†µã€‚</li>
<li><code>connectTimeoutMillis:Int</code> :å»ºç«‹è¿æ¥(TCP æˆ– TLS)çš„è¶…æ—¶æ—¶é—´ã€‚</li>
<li><code>readTimeoutMillis:Int</code> :å‘èµ·è¯·æ±‚åˆ°è¯»åˆ°å“åº”æ•°æ®çš„è¶…æ—¶æ—¶é—´ã€‚</li>
<li><code>writeTimeoutMillis :Int</code> :å‘èµ·è¯·æ±‚å¹¶è¢«ç›®æ ‡æœåŠ¡å™¨æ¥å—çš„è¶…æ—¶æ—¶é—´ã€‚(ä¸ºä»€ä¹ˆ?å› ä¸ºæœ‰æ—¶å€™å¯¹æ–¹æœåŠ¡å™¨å¯èƒ½ç”±äºæŸç§åŸå› è€Œä¸è¯»å–ä½ çš„ Request) newCall(Request) æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª<code>RealCall</code>å¯¹è±¡ï¼Œå®ƒæ˜¯Callæ¥å£</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wds1204.github.io/2022/02/04/okhttp%E6%A1%86%E6%9E%B6%E8%A7%A3%E6%9E%90/" data-id="clqp75lbq001xievhbk9rgn2d" class="article-share-link">
        åˆ†äº«
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/http/" rel="tag">http</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/okhttp/" rel="tag">okhttp</a></li></ul>

    </footer>

  </div>

  
  
<nav class="article-nav">
  
  <a href="/2022/02/10/okhttp%E6%8B%A6%E6%88%AA%E5%99%A8%E4%B9%8BRetryAndFollowUpInterceptor/" class="article-nav-link">
    <strong class="article-nav-caption">å‰ä¸€ç¯‡</strong>
    <div class="article-nav-title">
      
      okhttpæ‹¦æˆªå™¨ä¹‹RetryAndFollowUpInterceptor
      
    </div>
  </a>
  
  
  <a href="/2022/02/03/HTTPS/" class="article-nav-link">
    <strong class="article-nav-caption">åä¸€ç¯‡</strong>
    <div class="article-nav-title">HTTPS</div>
  </a>
  
</nav>

  

  
  
  
  

</article>
</section>
    <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>modi.wu &copy; 2023</li>
      
        <li>
          
            <a href="https://beian.miit.gov.cn/" target="_blank">WU</a>
            
        </li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
    <p><ul class="list-inline">
  
  <li><i class="fe fe-smile-alt tooltip" data-tooltip="UV"></i> <span id="busuanzi_value_site_uv"></span></li>
  
  <li><i class="fe fe-bookmark tooltip" data-tooltip="PV"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul></p>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="modi.wu"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">ä¸»é¡µ</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">å½’æ¡£</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/">åˆ†ç±»</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">ç›¸å†Œ</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">å…³äº</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="æœç´¢">
        <i class="fe fe-search"></i>
        æœç´¢
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>





<script src="/js/tocbot.min.js"></script>


<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
  });
</script>



<script src="/js/ocean.js"></script>

</body>

</html>