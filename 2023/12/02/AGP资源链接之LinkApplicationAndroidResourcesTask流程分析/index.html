<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <title>
    AGP资源链接之LinkApplicationAndroidResourcesTask流程分析 |
    
    modi.wu
  </title>
  <!-- Icon -->
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <main class="content">
    <section class="outer">
  <article id="post-AGP资源链接之LinkApplicationAndroidResourcesTask流程分析" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h1 class="article-title" itemprop="name">
    AGP资源链接之LinkApplicationAndroidResourcesTask流程分析
  </h1>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2023/12/02/AGP%E8%B5%84%E6%BA%90%E9%93%BE%E6%8E%A5%E4%B9%8BLinkApplicationAndroidResourcesTask%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2023-12-02T07:01:14.000Z" itemprop="datePublished">2023-12-02</time>
</a>
      
<div class="article-category">
  <a class="article-category-link" href="/categories/AGP/">AGP</a> / <a class="article-category-link" href="/categories/Gradle/">Gradle</a>
</div>

    </div>
    

    
    
<div class="tocbot"></div>

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
        <!-- -->
<span id="more"></span>
<h4 id="查找实现类"><a href="#查找实现类" class="headerlink" title="查找实现类"></a>查找实现类</h4><p>AGP link资源的过程所执行task的名称叫<code>processDebugResource</code>，我们需要根据task名称找到具体的实现类，Gradle提供了一个很实用的命令，可根据任务名查询实现类。</p>
<blockquote>
<p>./gradlew help –task <taskName></p>
</blockquote>
<p>查找<code>processDebugResources</code>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./gradlew <span class="built_in">help</span> --task processDebugResources</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Task :<span class="built_in">help</span></span></span><br><span class="line">Detailed task information for processDebugResources</span><br><span class="line">Path</span><br><span class="line">     :app:processDebugResources</span><br><span class="line">Type</span><br><span class="line">     LinkApplicationAndroidResourcesTask (com.android.build.gradle.internal.res.LinkApplicationAndroidResourcesTask)</span><br><span class="line">Description</span><br><span class="line">     -</span><br><span class="line">Group</span><br><span class="line">     -</span><br></pre></td></tr></table></figure>
<p>从终端的输出信息我们可以发现具体的实现类为<code>com.android.build.gradle.internal.res.LinkApplicationAndroidResourcesTask</code>。</p>
<h4 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h4><blockquote>
<p>本次分析的<code>AGP</code>源码版本7.2.2</p>
</blockquote>
<p><code>LinkApplicationAndroidResourcesTask</code>虽然也继承至<code>IncrementalTask</code>，但实际上该任务每次都会处理合并任务的全量结果集。虽然说<code>LinkApplicationAndroidResourcesTask</code>可以解析合并后资源的变化，但是因为link流程限制的原因：没有中间状态或缓存则无从处理变化的资源文件。<br />因为<code>LinkApplicationAndroidResourcesTask</code>每次都是全量编译，我们直接看<code>doFullTaskAction</code>方法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">doFullTaskAction</span><span class="params">(inputStableIdsFile: <span class="type">File</span>?)</span></span> &#123;</span><br><span class="line">        workerExecutor.noIsolation().submit(TaskAction::<span class="keyword">class</span>.java) &#123; parameters -&gt;</span><br><span class="line">            <span class="comment">//配置了很多参数</span></span><br><span class="line">            parameters.initializeFromAndroidVariantTask(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">            parameters.mainDexListProguardOutputFile.<span class="keyword">set</span>(mainDexListProguardOutputFile)</span><br><span class="line">            parameters.outputStableIdsFile.<span class="keyword">set</span>(stableIdsOutputFileProperty)</span><br><span class="line">            parameters.proguardOutputFile.<span class="keyword">set</span>(proguardOutputFile)</span><br><span class="line">            parameters.rClassOutputJar.<span class="keyword">set</span>(rClassOutputJar)</span><br><span class="line">            parameters.resPackageOutputDirectory.<span class="keyword">set</span>(resPackageOutputFolder)</span><br><span class="line">            parameters.sourceOutputDirectory.<span class="keyword">set</span>(sourceOutputDirProperty)</span><br><span class="line">            parameters.symbolsWithPackageNameOutputFile.<span class="keyword">set</span>(symbolsWithPackageNameOutputFile)</span><br><span class="line">            parameters.textSymbolOutputFile.<span class="keyword">set</span>(textSymbolOutputFileProperty)</span><br><span class="line"></span><br><span class="line">            parameters.androidJarInput.<span class="keyword">set</span>(androidJarInput)</span><br><span class="line">            parameters.aapt2.<span class="keyword">set</span>(aapt2)</span><br><span class="line">            parameters.symbolTableBuildService.<span class="keyword">set</span>(symbolTableBuildService)</span><br><span class="line"></span><br><span class="line">            parameters.aaptOptions.<span class="keyword">set</span>(AaptOptions(noCompress.orNull, aaptAdditionalParameters.orNull))</span><br><span class="line">            parameters.applicationId.<span class="keyword">set</span>(applicationId)</span><br><span class="line">            parameters.buildTargetDensity.<span class="keyword">set</span>(buildTargetDensity)</span><br><span class="line">            parameters.canHaveSplits.<span class="keyword">set</span>(canHaveSplits)</span><br><span class="line">            parameters.compiledDependenciesResources.from(compiledDependenciesResources)</span><br><span class="line">            parameters.dependencies.from(dependenciesFileCollection)</span><br><span class="line">            parameters.featureResourcePackages.from(featureResourcePackages)</span><br><span class="line">            parameters.imports.from(sharedLibraryDependencies)</span><br><span class="line">            parameters.incrementalDirectory.<span class="keyword">set</span>(incrementalFolder)</span><br><span class="line">            parameters.inputResourcesDirectory.<span class="keyword">set</span>(inputResourcesDir)</span><br><span class="line">            parameters.inputStableIdsFile.<span class="keyword">set</span>(inputStableIdsFile)</span><br><span class="line">            parameters.library.<span class="keyword">set</span>(isLibrary)</span><br><span class="line">            parameters.localResourcesFile.<span class="keyword">set</span>(localResourcesFile)</span><br><span class="line">            parameters.manifestFiles.<span class="keyword">set</span>(<span class="keyword">if</span> (aaptFriendlyManifestFiles.isPresent) aaptFriendlyManifestFiles <span class="keyword">else</span> manifestFiles)</span><br><span class="line">            parameters.manifestMergeBlameFile.<span class="keyword">set</span>(manifestMergeBlameFile)</span><br><span class="line">            parameters.mergeBlameDirectory.<span class="keyword">set</span>(mergeBlameLogFolder)</span><br><span class="line">            parameters.namespace.<span class="keyword">set</span>(namespace)</span><br><span class="line">            parameters.namespaced.<span class="keyword">set</span>(isNamespaced)</span><br><span class="line">            parameters.packageId.<span class="keyword">set</span>(resOffset)</span><br><span class="line">            parameters.resourceConfigs.<span class="keyword">set</span>(resourceConfigs)</span><br><span class="line">            parameters.sharedLibraryDependencies.from(sharedLibraryDependencies)</span><br><span class="line">            parameters.sourceSetMaps.from(sourceSetMaps)</span><br><span class="line">            parameters.useConditionalKeepRules.<span class="keyword">set</span>(useConditionalKeepRules)</span><br><span class="line">            parameters.useFinalIds.<span class="keyword">set</span>(useFinalIds)</span><br><span class="line">            parameters.useMinimalKeepRules.<span class="keyword">set</span>(useMinimalKeepRules)</span><br><span class="line">            parameters.useStableIds.<span class="keyword">set</span>(useStableIds)</span><br><span class="line">            parameters.variantName.<span class="keyword">set</span>(variantName)</span><br><span class="line">            parameters.variantOutputs.<span class="keyword">set</span>(variantOutputs.<span class="keyword">get</span>().map &#123; it.toSerializedForm() &#125;)</span><br><span class="line">            parameters.variantType.<span class="keyword">set</span>(type)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里使用到AGP自己内部的<code>workerExecutor</code>并行执行，触发<code>TaskAction</code>到<code>run</code>方法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskAction</span> : <span class="type">ProfileAwareWorkAction</span>&lt;<span class="type">TaskWorkActionParameters</span>&gt;</span>() &#123;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@get:Inject</span></span><br><span class="line">       <span class="keyword">abstract</span> <span class="keyword">val</span> workerExecutor: WorkerExecutor</span><br><span class="line"></span><br><span class="line">       <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">           <span class="comment">//合并后的Manifest工件</span></span><br><span class="line">           <span class="keyword">val</span> manifestBuiltArtifacts = BuiltArtifactsLoaderImpl().load(parameters.manifestFiles)</span><br><span class="line">               ?: <span class="keyword">throw</span> RuntimeException(<span class="string">&quot;Cannot load processed manifest files, please file a bug.&quot;</span>)</span><br><span class="line">           <span class="comment">// &#x27;Incremental&#x27; runs should only preserve the stable IDs file.</span></span><br><span class="line">           FileUtils.deleteDirectoryContents(parameters.resPackageOutputDirectory.<span class="keyword">get</span>().asFile)</span><br><span class="line"></span><br><span class="line">           <span class="keyword">val</span> variantOutputsList: List&lt;VariantOutputImpl.SerializedForm&gt; = parameters.variantOutputs.<span class="keyword">get</span>()</span><br><span class="line">           <span class="keyword">val</span> mainOutput = chooseOutput(variantOutputsList)</span><br><span class="line"></span><br><span class="line">           invokeAaptForSplit(</span><br><span class="line">                   mainOutput,</span><br><span class="line">                   manifestBuiltArtifacts.getBuiltArtifact(mainOutput.variantOutputConfiguration)</span><br><span class="line">                       ?: <span class="keyword">throw</span> RuntimeException(<span class="string">&quot;Cannot find built manifest for <span class="variable">$mainOutput</span>&quot;</span>),</span><br><span class="line">                   <span class="literal">true</span>,</span><br><span class="line">                   parameters.aapt2.<span class="keyword">get</span>().getLeasingAapt2(),</span><br><span class="line">                   parameters.inputStableIdsFile.orNull?.asFile, parameters</span><br><span class="line">           )</span><br><span class="line">       	<span class="comment">//...</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>aapt2 link的过程，指定构建的Android清单文件的路径是一个必须的配置，因为清单文件中包含应用的基本信息（如软件包名称和应用ID)。<br />内部调用<code>invokeAaptForSplit</code>方法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">invokeAaptForSplit</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        variantOutput: <span class="type">VariantOutputImpl</span>.<span class="type">SerializedForm</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        manifestOutput: <span class="type">BuiltArtifactImpl</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        generateRClass: <span class="type">Boolean</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        aapt2: <span class="type">Aapt2</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        stableIdsInputFile: <span class="type">File</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        parameters: <span class="type">TaskWorkActionParameters</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">val</span> resOutBaseNameFile =</span><br><span class="line">            getOutputBaseNameFile(variantOutput,</span><br><span class="line">                parameters.resPackageOutputDirectory.<span class="keyword">get</span>().asFile</span><br><span class="line">        )<span class="comment">//link过程中的输出文件路径build/intermediates/processed_res/debug/out/resources-debug.ap_</span></span><br><span class="line">        <span class="keyword">val</span> manifestFile = manifestOutput.outputFile</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the new resources flag is enabled and if we are dealing with a library process</span></span><br><span class="line">            <span class="comment">// resources through the new parsers</span></span><br><span class="line">            run &#123;</span><br><span class="line">                <span class="comment">//构建configBuilder</span></span><br><span class="line">                <span class="keyword">val</span> configBuilder = AaptPackageConfig.Builder()</span><br><span class="line">                    .setManifestFile(File(manifestFile))<span class="comment">//合并后的AndroidManifest的文件路径</span></span><br><span class="line">                    .setOptions(parameters.aaptOptions.<span class="keyword">get</span>())</span><br><span class="line">                    .setCustomPackageForR(packageForR)</span><br><span class="line">                    .setSymbolOutputDir(symbolOutputDir)</span><br><span class="line">                    .setSourceOutputDir(srcOut)</span><br><span class="line">                    .setResourceOutputApk(resOutBaseNameFile)<span class="comment">//设置link过程的输出文件路径</span></span><br><span class="line">                    .setProguardOutputFile(proguardOutputFile)</span><br><span class="line">                    .setMainDexListProguardOutputFile(mainDexListProguardOutputFile)</span><br><span class="line">                    .setVariantType(parameters.variantType.<span class="keyword">get</span>())</span><br><span class="line">                    .setResourceConfigs(parameters.resourceConfigs.<span class="keyword">get</span>())</span><br><span class="line">                    .setPreferredDensity(preferredDensity)</span><br><span class="line">                    .setPackageId(parameters.packageId.orNull)</span><br><span class="line">                    .setAllowReservedPackageId(</span><br><span class="line">                        parameters.packageId.isPresent &amp;&amp; parameters.packageId.<span class="keyword">get</span>() &lt; FeatureSetMetadata.BASE_ID</span><br><span class="line">                    )</span><br><span class="line">                    .setDependentFeatures(featurePackagesBuilder.build())</span><br><span class="line">                    .setImports(parameters.imports.files)</span><br><span class="line">                    .setIntermediateDir(parameters.incrementalDirectory.<span class="keyword">get</span>().asFile)</span><br><span class="line">                    .setAndroidJarPath(parameters.androidJarInput.<span class="keyword">get</span>()</span><br><span class="line">                        .getAndroidJar()</span><br><span class="line">                        .<span class="keyword">get</span>().absolutePath)<span class="comment">//平台的android.jar的路径</span></span><br><span class="line">                    .setUseConditionalKeepRules(parameters.useConditionalKeepRules.<span class="keyword">get</span>())</span><br><span class="line">                    .setUseMinimalKeepRules(parameters.useMinimalKeepRules.<span class="keyword">get</span>())</span><br><span class="line">                    .setUseFinalIds(parameters.useFinalIds.<span class="keyword">get</span>())</span><br><span class="line">                    .setEmitStableIdsFile(parameters.outputStableIdsFile.orNull?.asFile)</span><br><span class="line">                    .setConsumeStableIdsFile(stableIdsInputFile)</span><br><span class="line">                    .setLocalSymbolTableFile(parameters.localResourcesFile.orNull?.asFile)</span><br><span class="line">                    .setMergeBlameDirectory(parameters.mergeBlameDirectory.<span class="keyword">get</span>().asFile)</span><br><span class="line">                    .setManifestMergeBlameFile(parameters.manifestMergeBlameFile.orNull?.asFile)</span><br><span class="line">                    .apply &#123;</span><br><span class="line">                        <span class="keyword">val</span> compiledDependencyResourceFiles =</span><br><span class="line">                            parameters.compiledDependenciesResources.files</span><br><span class="line">                        <span class="comment">// In the event of running process[variant]AndroidTestResources</span></span><br><span class="line">                        <span class="comment">// on a module that depends on a module with no precompiled resources,</span></span><br><span class="line">                        <span class="comment">// we must avoid passing the compiled resource directory to AAPT link.</span></span><br><span class="line">                        <span class="keyword">if</span> (compiledDependencyResourceFiles.all(File::exists)) &#123;</span><br><span class="line">                            <span class="comment">//添加依赖库中的编译文件</span></span><br><span class="line">                            addResourceDirectories(</span><br><span class="line">                                compiledDependencyResourceFiles.reversed().toImmutableList())</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (parameters.namespaced.<span class="keyword">get</span>()) &#123;</span><br><span class="line">                    configBuilder.setStaticLibraryDependencies(ImmutableList.copyOf(parameters.dependencies.files))</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (generateRClass) &#123;</span><br><span class="line">                        <span class="comment">//生生成R.txt文件</span></span><br><span class="line">                        configBuilder.setLibrarySymbolTableFiles(parameters.dependencies.files)</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//添加资源编译任务的产物,build/intermediates/merged_res/debug/目录的文件</span></span><br><span class="line">                    configBuilder.addResourceDir(checkNotNull(parameters.inputResourcesDirectory.orNull?.asFile))</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">val</span> logger = Logging.getLogger(LinkApplicationAndroidResourcesTask::<span class="keyword">class</span>.java)</span><br><span class="line"></span><br><span class="line">                configBuilder.setIdentifiedSourceSetMap(</span><br><span class="line">                        mergeIdentifiedSourceSetFiles(</span><br><span class="line">                                parameters.sourceSetMaps.files.filterNotNull())</span><br><span class="line">                )</span><br><span class="line">                <span class="comment">//触发link动作</span></span><br><span class="line">                processResources(</span><br><span class="line">                    aapt = aapt2,</span><br><span class="line">                    aaptConfig = configBuilder.build(),</span><br><span class="line">                    rJar = <span class="keyword">if</span> (generateRClass) parameters.rClassOutputJar.orNull?.asFile <span class="keyword">else</span> <span class="literal">null</span>,</span><br><span class="line">                    logger = logger,</span><br><span class="line">                    errorFormatMode = parameters.aapt2.<span class="keyword">get</span>().getErrorFormatMode(),</span><br><span class="line">                    symbolTableLoader = parameters.symbolTableBuildService.<span class="keyword">get</span>()::loadClasspath,</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (LOG.isInfoEnabled) &#123;</span><br><span class="line">                    LOG.info(<span class="string">&quot;Aapt output file &#123;&#125;&quot;</span>, resOutBaseNameFile.absolutePath)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (generateRClass</span><br><span class="line">                &amp;&amp; (parameters.library.<span class="keyword">get</span>() || !parameters.dependencies.files.isEmpty())</span><br><span class="line">                &amp;&amp; parameters.symbolsWithPackageNameOutputFile.isPresent</span><br><span class="line">            ) &#123;</span><br><span class="line">                SymbolIo.writeSymbolListWithPackageName(</span><br><span class="line">                    parameters.textSymbolOutputFile.orNull?.asFile!!.toPath(),</span><br><span class="line">                    packageForR,</span><br><span class="line">                    parameters.symbolsWithPackageNameOutputFile.<span class="keyword">get</span>().asFile.toPath()</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">            appendOutput(</span><br><span class="line">                parameters.applicationId.<span class="keyword">get</span>().orEmpty(),</span><br><span class="line">                parameters.variantName.<span class="keyword">get</span>(),</span><br><span class="line">                manifestOutput.newOutput(</span><br><span class="line">                    resOutBaseNameFile.toPath()</span><br><span class="line">                ),</span><br><span class="line">                parameters.resPackageOutputDirectory.<span class="keyword">get</span>().asFile</span><br><span class="line">            )</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: ProcessException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> BuildException(</span><br><span class="line">                <span class="string">&quot;Failed to process resources, see aapt output above for details.&quot;</span>, e</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>invokeAaptForSplit</code>这个方法很长，省去很多其它不那么重要的代码方便阅读。通过建造者构建一个<code>configBuilder</code>对象，可以看到有很多配置。其中有一些关键的配置需要说明一下：<br /><code>processDebugResource</code>任务会输出一个<code>resources-debug.ap_</code>压缩文件，<code>setResourceOutputApk</code>就是在配置压缩文件的路径——<code>build/intermediates/processed_res/debug/out/resources-debug.ap_</code><br /><code>setAndroidJarPath</code>是在设置平台的<code>android.jar</code>路径，link的过程会使用<strong>android.jar</strong> 中包含的API信息来验证你的代码。<br /><code>addResourceDirectories</code>使用设置远程依赖库中的*.flat文件，<code>configBuilder.addResourceDir</code>设置项目<code>build/intermediates/merged_res/debug/</code>目录下的*.flat文件。<br />配置这些数据都是为后面的link作准备，直接进入<code>processResources</code>方法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">processResources</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    aapt: <span class="type">Aapt2</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    aaptConfig: <span class="type">AaptPackageConfig</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    rJar: <span class="type">File</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    logger: <span class="type">Logger</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    errorFormatMode: <span class="type">SyncOptions</span>.<span class="type">ErrorFormatMode</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    symbolTableLoader: (<span class="type">Iterable</span>&lt;<span class="type">File</span>&gt;) -&gt; <span class="type">List</span>&lt;<span class="type">SymbolTable</span>&gt; = &#123; SymbolIo()</span></span>.loadDependenciesSymbolTables(it) &#125;</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        aapt.link(aaptConfig, LoggerWrapper(logger))</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Aapt2Exception) &#123;</span><br><span class="line">        <span class="keyword">throw</span> rewriteLinkException(</span><br><span class="line">            e,</span><br><span class="line">            errorFormatMode,</span><br><span class="line">            aaptConfig.mergeBlameDirectory,</span><br><span class="line">            aaptConfig.manifestMergeBlameFile,</span><br><span class="line">            aaptConfig.identifiedSourceSetMap,</span><br><span class="line">            logger</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Aapt2InternalException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ProcessException(<span class="string">&quot;Failed to execute aapt&quot;</span>, e)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 在上篇分析<a href="https://wds1204.github.io/2023/12/02/AGP%E8%B5%84%E6%BA%90%E7%BC%96%E8%AF%91%E4%B9%8BMergeMergeResources%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#Aapt2CompileRunnable">MergeResources流程分析</a>的文章中知道<code>aapt</code>的实例对象是<code>PartialInProcessResourceProcessor</code>，内部调用<code>delegate</code>的<code>link</code>方法，最终调用的是<code>Aapt2DaemonImpl</code>的<code>link</code>方法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Aapt2Daemon</span></span>(</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">val</span> displayName: String,</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">val</span> logger: ILogger) : Aapt2 &#123;</span><br><span class="line">	<span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">link</span><span class="params">(request: <span class="type">AaptPackageConfig</span>, logger: <span class="type">ILogger</span>)</span></span> &#123;</span><br><span class="line">        checkStarted()<span class="comment">//检查aapt进程是开启</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            doLink(request, logger)<span class="comment">//调用</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Aapt2Exception) &#123;</span><br><span class="line">            <span class="comment">// Propagate errors in the users sources directly.</span></span><br><span class="line">            <span class="keyword">throw</span> e</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: TimeoutException) &#123;</span><br><span class="line">            handleError(<span class="string">&quot;Link timed out&quot;</span>, e)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            handleError(<span class="string">&quot;Unexpected error during link&quot;</span>, e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>checkStarted流程在<a href="https://wds1204.github.io/2023/12/02/AGP%E8%B5%84%E6%BA%90%E7%BC%96%E8%AF%91%E4%B9%8BMergeMergeResources%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#Aapt2CompileRunnable">MergeResources流程分析</a>已经看过，<code>Aapt2DaemonImpl</code>的<code>doLink</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Aapt2DaemonImpl</span></span>(</span><br><span class="line">    displayId: String,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> aaptPath: String,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> aaptCommand: List&lt;String&gt;,</span><br><span class="line">    versionString: String,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> daemonTimeouts: Aapt2DaemonTimeouts,</span><br><span class="line">    logger: ILogger) :</span><br><span class="line">Aapt2Daemon(</span><br><span class="line">    displayName = <span class="string">&quot;AAPT2 <span class="variable">$versionString</span> Daemon <span class="variable">$displayId</span>&quot;</span>,</span><br><span class="line">    logger = logger)&#123;</span><br><span class="line">     <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doLink</span><span class="params">(request: <span class="type">AaptPackageConfig</span>, logger: <span class="type">ILogger</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> waitForTask = WaitForTaskCompletion(displayName, logger)</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            processOutput.delegate = waitForTask</span><br><span class="line">            Aapt2DaemonUtil.requestLink(writer, request)</span><br><span class="line">            <span class="keyword">val</span> result = waitForTask.future.<span class="keyword">get</span>(daemonTimeouts.link, daemonTimeouts.linkUnit)</span><br><span class="line">           <span class="comment">//...</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            processOutput.delegate = noOutputExpected</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Aapt2DaemonUtil.requestLink</code>方法是往aapt进程的写入句柄输入参数并flush，然后读取link命令的执行结果。具体各个参数的说明大家可以参考<a target="_blank" rel="noopener" href="https://developer.android.com/studio/command-line/aapt2?hl=zh-cn#link_options">link_options</a>官方文档。</p>
<h4 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h4><p><code>LinkApplicationAndroidResourcesTask</code>相比<code>MergeResouces</code>的过程要简单很多，只是启动了一个appt进程，把编译后的*.flat产物给aapt进程处理生产产物。<br><img src="/../images/agplink/Snipaste_2023-12-03_22-32-12.png" alt="Alt text"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wds1204.github.io/2023/12/02/AGP%E8%B5%84%E6%BA%90%E9%93%BE%E6%8E%A5%E4%B9%8BLinkApplicationAndroidResourcesTask%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" data-id="clppnyloa0009atvhht6peczf" class="article-share-link">
        分享
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AGP/" rel="tag">AGP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Gradle/" rel="tag">Gradle</a></li></ul>

    </footer>

  </div>

  
  
<nav class="article-nav">
  
  
  <a href="/2023/12/02/AGP%E8%B5%84%E6%BA%90%E7%BC%96%E8%AF%91%E4%B9%8BMergeResources%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" class="article-nav-link">
    <strong class="article-nav-caption">后一篇</strong>
    <div class="article-nav-title">AGP资源编译之MergeResources流程分析</div>
  </a>
  
</nav>

  

  
  
  
  

</article>
</section>
    <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>modi.wu &copy; 2023</li>
      
        <li>
          
            <a href="https://beian.miit.gov.cn/" target="_blank">WU</a>
            
        </li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
    <p><ul class="list-inline">
  
  <li><i class="fe fe-smile-alt tooltip" data-tooltip="UV"></i> <span id="busuanzi_value_site_uv"></span></li>
  
  <li><i class="fe fe-bookmark tooltip" data-tooltip="PV"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul></p>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="modi.wu"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">相册</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        搜索
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>





<script src="/js/tocbot.min.js"></script>


<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
  });
</script>



<script src="/js/ocean.js"></script>

</body>

</html>